<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ArchaeologyWorld | Plataforma Profissional de Arqueologia Digital</title>

    <!-- Favicon -->
    <link rel="icon" href="fotos/Fgura-5-Enterramento-15-do-sitio-Pedra-do-Alexandre-Area-Arqueologica-do-Serido (1).png" type="image/png">

    <!-- OPCIONAL: pré-conexão só para fontes Google -->
    <link rel="preconnect" href="https://fonts.googleapis.com">

    <!-- Font Awesome LOCAL -->
    <link rel="stylesheet" href="/lib/fontawesome/all.min.css">

    <!-- Leaflet LOCAL -->
    <link rel="stylesheet" href="/lib/leaflet/leaflet.css">

    <!-- Fontes Google -->
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Raleway:wght@300;400;600&display=swap"
          rel="stylesheet">

    <!-- PWA -->
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#2c5530">
    
    <style>
        :root {
            --primary-color: #2c5530;
            --secondary-color: #d4af37;
            --accent-color: #28a745;
            --danger-color: #dc3545;
            --text-color: #333;
            --light-bg: #f8f9fa;
            --white: #ffffff;
            --shadow: 0 2px 10px rgba(0,0,0,0.1);
            --transition: all 0.3s ease;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
/* ===== Acessibilidade: tamanhos de fonte ===== */
html {
  font-size: 100%; /* base 16px, fácil de escalar com rem */
}

/* body base (mantendo seu estilo original) */
body {
  font-family: 'Raleway', sans-serif;
  line-height: 1.6;
  color: #333;
  background-color: #f8f9fa;
  padding-top: 3.3rem; /* espaço para barra + header fixos */
}

/* classes de tamanho relativas ao <body> */
body.font-size-small {
  font-size: 0.9rem;
}

body.font-size-normal {
  font-size: 1rem;
}

body.font-size-large {
  font-size: 1.15rem;
}

body.font-size-xlarge {
  font-size: 1.3rem;
}

/* ===== Acessibilidade: alto contraste ===== */
body.high-contrast {
  background-color: #000;
  color: #fff;
}

body.high-contrast a {
  color: #ffeb3b;
}

body.high-contrast header,
body.high-contrast .search-section,
body.high-contrast .map-section,
body.high-contrast .features-section,
body.high-contrast .cta-section,
body.high-contrast footer {
  background-color: #000 !important;
  color: #fff !important;
}

body.high-contrast .btn,
body.high-contrast button,
body.high-contrast .filter-btn {
  background-color: #000;
  color: #fff;
  border: 2px solid #fff;
}

/* ===== Barra de acessibilidade fixa no topo ===== */
.accessibility-toolbar {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  z-index: 1100; /* acima do header (1000) */
  display: flex;
  gap: 0.5rem;
  align-items: center;
  justify-content: flex-start;
  padding: 0.3rem 0.9rem;
  background-color: #111;
  color: #fff;
  font-size: 0.9rem;
  box-shadow: 0 2px 6px rgba(0,0,0,0.4);
}

/* botões da barra */
.accessibility-toolbar .acc-btn {
  background: transparent;
  border: 1px solid #fff;
  color: #fff;
  padding: 0.25rem 0.7rem;
  border-radius: 4px;
  cursor: pointer;
  font-size: 0.85rem;
  font-weight: 600;
  transition: background-color 0.2s ease, color 0.2s ease, transform 0.1s ease;
}

.accessibility-toolbar .acc-btn:hover,
.accessibility-toolbar .acc-btn:focus-visible {
  background-color: #fff;
  color: #000;
  transform: translateY(-1px);
}

/* ===== Foco visível global ===== */
:focus-visible {
  outline: 3px solid #ff9800;
  outline-offset: 2px;
}

        body {
            font-family: 'Raleway', sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f8f9fa;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        /* Header */
        header {
            background: #2c5530;
            color: white;
            padding: 1rem 0;
            position: fixed;
            width: 100%;
            top: 0;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            text-decoration: none;
            color: white;
        }

        .logo img {
            height: 40px;
            margin-right: 10px;
            border-radius: 5px;
        }

        .logo-text {
            font-family: 'Playfair Display', serif;
            font-size: 1.5rem;
            font-weight: 700;
        }

        .logo-text span {
            color: #d4af37;
        }

        nav ul {
            display: flex;
            list-style: none;
            gap: 2rem;
            align-items: center;
        }

        nav a {
            color: white;
            text-decoration: none;
            font-weight: 600;
            transition: color 0.3s ease;
        }

        nav a:hover {
            color: #d4af37;
        }

        .cta-button {
            background: #d4af37;
            color: #2c5530;
            padding: 0.5rem 1.5rem;
            border-radius: 25px;
            font-weight: 700;
            transition: all 0.3s ease;
        }

        .cta-button:hover {
            background: #b8941f;
            transform: translateY(-2px);
        }

        /* Botão Adicionar */
        .add-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 0.5rem 1.5rem;
            border-radius: 25px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .add-btn:hover {
            background: #218838;
            transform: translateY(-2px);
        }

        /* Botão Logout */
        .logout-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 0.3rem 1rem;
            border-radius: 20px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .logout-btn:hover {
            background: #c82333;
            transform: translateY(-2px);
        }

        /* Barra de Pesquisa */
        .search-section {
            padding: 120px 0 60px;
            background: linear-gradient(135deg, #2c5530, #1e3a22);
            color: white;
            text-align: center;
        }

        .search-container {
            max-width: 700px;
            margin: 0 auto;
        }

        .search-title {
            font-family: 'Playfair Display', serif;
            font-size: 2.5rem;
            margin-bottom: 1.5rem;
            font-weight: 700;
        }

        .search-subtitle {
            font-size: 1.2rem;
            margin-bottom: 2rem;
            opacity: 0.9;
        }

        .search-box {
            position: relative;
            margin-bottom: 1rem;
        }

        .search-input {
            width: 100%;
            padding: 15px 60px 15px 20px;
            border: none;
            border-radius: 50px;
            font-size: 1.1rem;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }

        .search-input:focus {
            outline: none;
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
            transform: translateY(-2px);
        }

        .search-button {
            position: absolute;
            right: 5px;
            top: 5px;
            background: #d4af37;
            color: #2c5530;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .search-button:hover {
            background: #b8941f;
            transform: scale(1.05);
        }

        .search-examples {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .search-examples span {
            margin: 0 5px;
            cursor: pointer;
            text-decoration: underline;
        }

        .search-examples span:hover {
            color: #d4af37;
        }

        /* Sugestões de Busca */
        .search-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border-radius: 0 0 10px 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            z-index: 1000;
            max-height: 300px;
            overflow-y: auto;
            display: none;
        }

        .search-suggestions.active {
            display: block;
        }

        .suggestion-item {
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
            transition: background-color 0.2s;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .suggestion-item:hover {
            background-color: #f8f9fa;
        }

        .suggestion-item:last-child {
            border-bottom: none;
        }

        .suggestion-icon {
            color: #666;
            font-size: 0.9rem;
            width: 20px;
            text-align: center;
        }

        /* Busca Avançada */
        .search-advanced {
            margin-top: 15px;
            text-align: left;
        }

        .search-advanced-toggle {
            color: #d4af37;
            cursor: pointer;
            font-size: 0.9rem;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .search-advanced-options {
            margin-top: 10px;
            padding: 15px;
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
            display: none;
        }

        .search-advanced-options.active {
            display: block;
        }

        .search-advanced-group {
            margin-bottom: 10px;
        }

        .search-advanced-group label {
            display: block;
            margin-bottom: 5px;
            font-size: 0.9rem;
        }

        .search-advanced-group select {
            width: 100%;
            padding: 8px;
            border-radius: 4px;
            border: 1px solid rgba(255,255,255,0.3);
            background: rgba(255,255,255,0.1);
            color: white;
        }

        .search-advanced-group select option {
            background: #2c5530;
            color: white;
        }

        /* Resultados da Pesquisa - Estilo Google */
        .search-results {
            padding: 40px 0;
            background: white;
            display: none;
        }

        .search-results.active {
            display: block;
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            border-bottom: 1px solid #eee;
            padding-bottom: 1rem;
        }

        .results-count {
            font-size: 1.1rem;
            color: #666;
        }

        .results-filters {
            display: flex;
            gap: 10px;
        }

        .filter-option {
            padding: 8px 15px;
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .filter-option.active {
            background: #2c5530;
            color: white;
            border-color: #2c5530;
        }

        /* Estatísticas e Ordenação */
        .search-stats {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 15px;
        }

        .search-sort {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .search-sort label {
            font-size: 0.9rem;
            color: #666;
        }

        .search-sort select {
            padding: 5px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
        }

        /* Resultados */
        .result-item {
            margin-bottom: 2.5rem;
            max-width: 650px;
            padding: 15px;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .result-item:hover {
            background-color: #f8f9fa;
        }

        .result-featured {
            border-left: 4px solid #d4af37;
            padding-left: 15px;
        }

        .result-title {
            font-size: 1.25rem;
            color: #1a0dab;
            margin-bottom: 0.25rem;
            line-height: 1.3;
            cursor: pointer;
        }

        .result-title:hover {
            text-decoration: underline;
        }

        .result-link {
            color: #006621;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
            display: block;
        }

        .result-description {
            color: #545454;
            line-height: 1.58;
            font-size: 0.95rem;
        }

        .result-highlight {
            background-color: #fff9e6;
            padding: 2px 4px;
            border-radius: 3px;
        }

        .result-sources {
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid #eee;
        }

        .sources-title {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 0.5rem;
        }

        .sources-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .source-link {
            color: #1a0dab;
            font-size: 0.85rem;
            text-decoration: none;
            padding: 4px 8px;
            background: #f1f3f4;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .source-link:hover {
            background: #e8eaed;
            text-decoration: underline;
        }

        .result-meta {
            display: flex;
            gap: 15px;
            margin-top: 0.75rem;
            font-size: 0.85rem;
            color: #666;
        }

        .result-type {
            background: #e8f5e8;
            color: #2c5530;
            padding: 2px 8px;
            border-radius: 12px;
            font-weight: 500;
        }

        /* Tags de Pesquisa */
        .search-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        .search-tag {
            background: #e8f5e8;
            color: #2c5530;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .search-tag:hover {
            background: #d4edda;
        }

        /* Paginação */
        .pagination {
            display: flex;
            justify-content: center;
            margin-top: 30px;
            gap: 10px;
        }

        .pagination button {
            padding: 8px 15px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .pagination button:hover {
            background: #f8f9fa;
        }

        .pagination button.active {
            background: #2c5530;
            color: white;
            border-color: #2c5530;
        }

        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .no-results {
            text-align: center;
            padding: 3rem 0;
            color: #666;
        }

        .no-results i {
            font-size: 3rem;
            margin-bottom: 1rem;
            color: #ddd;
        }

        .search-loading {
            text-align: center;
            padding: 2rem 0;
            color: #666;
        }

        .search-loading i {
            font-size: 2rem;
            margin-bottom: 1rem;
            color: #2c5530;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Resumo Inteligente */
        .intelligent-summary {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 30px;
            border-left: 4px solid #2c5530;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }

        .summary-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            gap: 10px;
        }

        .summary-header i {
            color: #2c5530;
            font-size: 1.5rem;
        }

        .summary-header h2 {
            color: #2c5530;
            font-family: 'Playfair Display', serif;
            margin: 0;
            font-size: 1.4rem;
        }

        .summary-content {
            line-height: 1.6;
            color: #444;
            font-size: 1rem;
        }

        .summary-key-points {
            margin-top: 15px;
            padding-left: 20px;
        }

        .summary-key-points li {
            margin-bottom: 8px;
            position: relative;
        }

        .summary-key-points li:before {
            content: "•";
            color: #2c5530;
            font-weight: bold;
            position: absolute;
            left: -15px;
        }

        .summary-sources {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #ddd;
        }

        .summary-sources h4 {
            color: #666;
            margin-bottom: 10px;
            font-size: 0.9rem;
        }

        .summary-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 15px;
        }

        .summary-tag {
            background: #2c5530;
            color: white;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .summary-tag:hover {
            background: #1e3a22;
            transform: translateY(-2px);
        }

        /* Novos estilos para sistema de respostas inteligentes */
        .enhanced-response {
            background: white;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            border-left: 4px solid #2c5530;
        }
        
        .response-main {
            margin-bottom: 20px;
        }
        
        .key-facts, .significance, .controversies, .external-info {
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 3px solid #d4af37;
        }
        
        .key-facts h3, .significance h3, .controversies h3, .external-info h3 {
            color: #2c5530;
            margin-bottom: 10px;
            font-family: 'Playfair Display', serif;
        }
        
        .key-facts ul {
            list-style: none;
            padding: 0;
        }
        
        .key-facts li {
            padding: 8px 0;
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: center;
        }
        
        .key-facts li:before {
            content: "•";
            color: #d4af37;
            font-weight: bold;
            margin-right: 10px;
            font-size: 1.2em;
        }
        
        .definition-response, .location-response {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .quick-facts {
            background: #e8f5e8;
            padding: 15px;
            border-radius: 6px;
            margin-top: 15px;
        }
        
        .sites-list {
            margin-top: 15px;
        }
        
        .sites-list ul {
            list-style: none;
            padding: 0;
        }
        
        .sites-list li {
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }
        
        /* Estilos para respostas por intenção */
        .intent-response {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 4px solid #2c5530;
        }
        
        .intent-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .intent-icon {
            font-size: 1.5rem;
            color: #2c5530;
        }
        
        .intent-title {
            color: #2c5530;
            font-family: 'Playfair Display', serif;
            margin: 0;
        }
        
        /* Melhorias no resumo inteligente existente */
        .summary-key-points {
            background: #fff9e6;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }
        
        .summary-key-points h4 {
            color: #2c5530;
            margin-bottom: 10px;
        }

        /* Hero Section */
        .hero {
            background: linear-gradient(rgba(44, 85, 48, 0.8), rgba(44, 85, 48, 0.9));
            background-size: cover;
            background-position: center;
            color: white;
            padding: 180px 0 100px;
            text-align: center;
        }

        .hero-content h1 {
            font-family: 'Playfair Display', serif;
            font-size: 3.5rem;
            margin-bottom: 1.5rem;
            font-weight: 700;
        }

        .hero-content p {
            font-size: 1.3rem;
            margin-bottom: 2.5rem;
            max-width: 700px;
            margin-left: auto;
            margin-right: auto;
        }

        .hero-buttons {
            display: flex;
            gap: 1rem;
            justify-content: center;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 5px;
            font-size: 1.1rem;
            font-weight: 600;
            text-decoration: none;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .btn-primary {
            background: #d4af37;
            color: #2c5530;
        }

        .btn-primary:hover {
            background: #b8941f;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: transparent;
            color: white;
            border: 2px solid white;
        }

        .btn-secondary:hover {
            background: white;
            color: #2c5530;
        }

        /* Seção Saiba Mais */
        .saiba-mais-sobre {
            padding: 80px 0;
            background: white;
        }

        .saiba-mais-sobre h1 {
            font-family: 'Playfair Display', serif;
            color: #2c5530;
            font-size: 2.5rem;
            margin-bottom: 2rem;
            text-align: center;
        }

        .saiba-mais-sobre p {
            font-size: 1.2rem;
            line-height: 1.8;
            max-width: 800px;
            margin: 0 auto;
            text-align: center;
            color: #666;
        }

        /* Seção do Mapa */
        .map-section {
            padding: 80px 0;
            background: #f8f9fa;
        }

        .section-header {
            text-align: center;
            margin-bottom: 3rem;
        }

        .section-title {
            font-family: 'Playfair Display', serif;
            color: #2c5530;
            font-size: 2.5rem;
            margin-bottom: 1rem;
        }

        .section-subtitle {
            font-size: 1.2rem;
            color: #666;
            max-width: 600px;
            margin: 0 auto;
        }

        .map-container {
            position: relative;
            height: 600px;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        #archaeologicalMap {
            height: 100%;
            width: 100%;
        }

        /* Filtros do Mapa - POSICIONAMENTO CORRIGIDO */
        .map-filters {
            position: absolute;
            top: 80px; /* Posicionado abaixo do cabeçalho */
            left: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            z-index: 999; /* Z-index menor que o header */
            min-width: 200px;
            padding: 15px;
        }

        .filter-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }

        .filter-header h3 {
            color: #2c5530;
            font-size: 1rem;
            margin: 0;
        }

        .filter-group {
            margin-bottom: 15px;
        }

        .filter-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
            font-size: 0.9rem;
        }

        .filter-group select {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            font-family: 'Raleway', sans-serif;
        }

        .filter-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .filter-btn {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #2c5530;
            background: #2c5530;
            color: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .filter-btn:hover {
            background: #1e3a22;
        }

        .filter-btn.secondary {
            background: transparent;
            color: #2c5530;
        }

        .filter-btn.secondary:hover {
            background: #2c5530;
            color: white;
        }

        /* Legenda do Mapa - POSICIONAMENTO CORRIGIDO */
        .map-overlay {
            position: absolute;
            top: 80px; /* Posicionado abaixo do cabeçalho */
            right: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            z-index: 999; /* Z-index menor que o header */
            min-width: 200px;
        }

        .legend-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #eee;
        }

        .legend-header h3 {
            color: #2c5530;
            font-size: 1rem;
            margin: 0;
        }

        .toggle-button {
            background: none;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            color: #666;
        }

        .map-legend {
            padding: 15px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 10px;
            border: 2px solid white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        /* Modal de Adicionar */
        .add-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .add-modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid #eee;
            padding-bottom: 15px;
        }

        .modal-header h2 {
            margin: 0;
            color: #2c5530;
            font-size: 1.5rem;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            font-family: 'Raleway', sans-serif;
        }

        .form-group textarea {
            height: 80px;
            resize: vertical;
        }

        .form-row {
            display: flex;
            gap: 15px;
        }

        .form-row .form-group {
            flex: 1;
        }

        .form-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 25px;
        }

        /* Mapa dentro do modal */
        .modal-map-container {
            height: 300px;
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 15px;
            border: 2px solid #ddd;
        }

        #modalMap {
            height: 100%;
            width: 100%;
        }

        .coordinates-input {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .coordinates-input input {
            flex: 1;
        }

        .map-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .map-controls button {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #ddd;
            background: #f8f9fa;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .map-controls button:hover {
            background: #e9ecef;
        }

        .coordinates-info {
            background: #e9ecef;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            font-size: 14px;
            text-align: center;
        }

        /* Estilos para upload de arquivo */
        .upload-options {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .upload-option {
            flex: 1;
            text-align: center;
            padding: 10px;
            background: #f8f9fa;
            border: 2px solid #ddd;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .upload-option.active {
            background: #2c5530;
            color: white;
            border-color: #2c5530;
        }

        .file-upload-container {
            margin-bottom: 15px;
        }

        .file-input-wrapper {
            position: relative;
            display: inline-block;
            width: 100%;
        }

        .file-input {
            position: absolute;
            left: -9999px;
        }

        .file-input-button {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px 20px;
            background: #f8f9fa;
            border: 2px dashed #ddd;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            color: #666;
        }

        .file-input-button:hover {
            background: #e9ecef;
            border-color: #2c5530;
        }

        .file-name {
            margin-top: 8px;
            font-size: 0.9rem;
            color: #666;
            text-align: center;
        }

        .image-preview {
            max-width: 100%;
            max-height: 200px;
            margin-top: 15px;
            border-radius: 8px;
            border: 2px solid #ddd;
            display: none;
        }

        /* Estilos para os marcadores do mapa */
        .site-marker {
            text-align: center;
        }

        .marker-pin {
            width: 30px;
            height: 30px;
            border-radius: 50% 50% 50% 0;
            background: #2c5530;
            position: absolute;
            transform: rotate(-45deg);
            left: 50%;
            top: 50%;
            margin: -15px 0 0 -15px;
        }

        .site-marker i {
            position: absolute;
            width: 24px;
            font-size: 18px;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            color: white;
        }

        .selection-marker .marker-pin {
            background: #28a745;
            border: 3px solid #fff;
            box-shadow: 0 0 10px rgba(40, 167, 69, 0.5);
        }

        /* Botão no popup */
        .site-link-button {
            background: #2c5530;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 10px;
            width: 100%;
            font-family: 'Raleway', sans-serif;
        }

        .site-link-button:hover {
            background: #1e3a22;
        }

        /* Popup do mapa */
        .map-popup {
            max-width: 300px;
        }

        .map-popup h2 {
            color: #2c5530;
            margin-bottom: 10px;
            font-size: 1.3rem;
            font-family: 'Playfair Display', serif;
        }

        .map-popup img {
            width: 100%;
            height: 150px;
            object-fit: cover;
            border-radius: 5px;
            margin-bottom: 10px;
        }

        .popup-meta p {
            margin-bottom: 5px;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        /* Seções adicionais */
        .features-section, .stratigraphy-section, .data-section, .cta-section {
            padding: 80px 0;
        }

        .features-section {
            background: white;
        }

        .features-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
        }

        .feature-card {
            background: #f8f9fa;
            padding: 2rem;
            border-radius: 10px;
            text-align: center;
            transition: transform 0.3s ease;
        }

        .feature-card:hover {
            transform: translateY(-5px);
        }

        .feature-icon {
            font-size: 3rem;
            color: #2c5530;
            margin-bottom: 1rem;
        }

        .feature-card h3 {
            color: #2c5530;
            margin-bottom: 1rem;
            font-family: 'Playfair Display', serif;
        }

        .feature-card p {
            color: #666;
            margin-bottom: 1rem;
        }

        .feature-link {
            color: #2c5530;
            text-decoration: none;
            font-weight: 600;
        }

        .cta-section {
            background: linear-gradient(135deg, #2c5530, #1e3a22);
            color: white;
            text-align: center;
        }

        /* Footer */
        footer {
            background: #1a1a1a;
            color: white;
            padding: 50px 0 20px;
        }

        .footer-content {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .footer-column h3 {
            color: #d4af37;
            margin-bottom: 1rem;
            font-family: 'Playfair Display', serif;
        }

        .footer-column ul {
            list-style: none;
        }

        .footer-column ul li {
            margin-bottom: 0.5rem;
        }

        .footer-column a {
            color: #ccc;
            text-decoration: none;
            transition: color 0.3s ease;
        }

        .footer-column a:hover {
            color: #d4af37;
        }

        .footer-social {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
        }

        .footer-social a {
            color: white;
            font-size: 1.2rem;
        }

        .footer-bottom {
            text-align: center;
            padding-top: 2rem;
            border-top: 1px solid #333;
            color: #999;
        }

        /* Novos estilos para melhorias da pesquisa */
        .search-analytics {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #2c5530;
        }
        
        .analytics-item {
            font-weight: 600;
            color: #2c5530;
            margin-bottom: 5px;
        }
        
        .analytics-breakdown {
            font-size: 0.9rem;
            color: #666;
        }
        
        .search-tips {
            background: #fff9e6;
            padding: 10px 15px;
            border-radius: 8px;
            margin-top: 10px;
            font-size: 0.9rem;
            border-left: 4px solid #f39c12;
        }
        
        .suggestion-category {
            font-weight: 600;
            color: #2c5530;
            padding: 8px 15px;
            background: #f8f9fa;
            border-bottom: 1px solid #eee;
            font-size: 0.8rem;
            text-transform: uppercase;
        }
        
        .history-item {
            padding: 8px 15px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .history-query {
            font-weight: 500;
        }
        
        .history-meta {
            font-size: 0.8rem;
            color: #666;
        }

        /* Notificações */
        .notification {
            position: fixed;
            top: 100px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            z-index: 10000;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            transform: translateX(400px);
            transition: transform 0.3s ease;
            max-width: 300px;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            background: #28a745;
        }

        .notification.error {
            background: #dc3545;
        }

        .notification.info {
            background: #17a2b8;
        }

        .notification.warning {
            background: #ffc107;
            color: #212529;
        }

        /* Responsividade */
        @media (max-width: 768px) {
            .header-container {
                flex-direction: column;
                gap: 1rem;
            }

            nav ul {
                flex-wrap: wrap;
                justify-content: center;
                gap: 1rem;
            }

            .hero-content h1 {
                font-size: 2.5rem;
            }

            .hero-buttons {
                flex-direction: column;
                align-items: center;
            }

            .map-overlay, .map-filters {
                position: relative;
                top: auto;
                right: auto;
                left: auto;
                margin-bottom: 20px;
                width: 90%;
            }

            .modal-content {
                width: 95%;
                margin: 20px;
                padding: 20px;
            }

            .form-row {
                flex-direction: column;
                gap: 0;
            }

            .coordinates-input {
                flex-direction: column;
            }

            .upload-options {
                flex-direction: column;
            }

            .search-title {
                font-size: 2rem;
            }

            .results-header {
                flex-direction: column;
                gap: 15px;
                align-items: flex-start;
            }

            .results-filters {
                width: 100%;
                overflow-x: auto;
                padding-bottom: 10px;
            }

            .search-sort {
                flex-direction: column;
                align-items: flex-start;
            }

            .pagination {
                flex-wrap: wrap;
            }

            .notification {
                right: 10px;
                left: 10px;
                max-width: none;
            }
        }
    </style>
</head>
<body>
  <!-- Notificações -->
  <div id="notification" class="notification" style="display: none;"></div>

  <!-- Barra de acessibilidade -->
  <div class="accessibility-toolbar" aria-label="Opções de acessibilidade">
    <button id="acc-skip" class="acc-btn">
      Ir para o conteúdo
    </button>
    <button id="acc-font-increase" class="acc-btn" aria-label="Aumentar tamanho da fonte">
      A+
    </button>
    <button id="acc-font-decrease" class="acc-btn" aria-label="Diminuir tamanho da fonte">
      A-
    </button>
    <button id="acc-contrast-toggle" class="acc-btn" aria-pressed="false">
      Alto contraste
    </button>
  </div>

  <!-- Header -->
  <header>
    <div class="container header-container">
      <a class="logo">
        <img src="fotos/b920f10b-c8ff-4e69-aeaf-515171ddf4ec.jpg" alt="Archaeology World Logo">
        <div class="logo-text">Archaeology <span>World</span></div>
      </a>
      <nav aria-label="Navegação principal">
        <ul>
          <li><a href="#sobre">saiba mais</a></li>
          <li><a href="#search">Pesquisa</a></li>
          <li><a href="#map">Mapa Interativo</a></li>
          <li><a href="#features">Recursos</a></li>
          <li><a href="#stratigraphy">Estratigrafia</a></li>
          <li><a href="#data">Análises</a></li>
          <li id="addButtonContainer"><!-- Preenchido via JS --></li>
          <li id="loginButtonContainer"><!-- Preenchido via JS --></li>
        </ul>
      </nav>
    </div>
  </header>

  <!-- CONTEÚDO PRINCIPAL (alvo do skip-link) -->
  <main id="conteudo-principal" role="main" tabindex="-1">
    <!-- Modal para Adicionar Novo Item -->
    <div id="addModal" class="add-modal" aria-hidden="true" aria-labelledby="addModalTitle" role="dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h2 id="addModalTitle">Adicionar Novo Sítio/Descoberta</h2>
          <button class="close-modal" onclick="closeAddModal()" aria-label="Fechar formulário de novo sítio">&times;</button>
        </div>

        <form id="addForm">
          <div class="form-group">
            <label for="itemName">Nome do Local/Descoberta *</label>
            <input type="text" id="itemName" name="itemName" required placeholder="Ex: Sítio Arqueológico do Sol">
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="itemType">Tipo *</label>
              <select id="itemType" name="itemType" required>
                <option value="">Selecione o tipo</option>
                <option value="Sítio em Escavação">Sítio em Escavação</option>
                <option value="Sítio Documentado">Sítio Documentado</option>
                <option value="Área Protegida">Área Protegida</option>
                <option value="Artefato Registrado">Artefato Registrado</option>
                <option value="Estrutura Arqueológica">Estrutura Arqueológica</option>
                <option value="Museus Arqueológicos">Museu Arqueológico</option>
              </select>
            </div>
            <div class="form-group">
              <label for="itemPeriod">Período *</label>
              <input type="text" id="itemPeriod" name="itemPeriod" required placeholder="Ex: Holoceno Inicial">
            </div>
          </div>

          <div class="form-group">
            <label>Localização *</label>
            <div class="map-controls">
              <button type="button" onclick="enableMapSelection()">
                <i class="fas fa-mouse-pointer" aria-hidden="true"></i> Clicar no Mapa
              </button>
              <button type="button" onclick="useCurrentLocation()">
                <i class="fas fa-location-arrow" aria-hidden="true"></i> Minha Localização
              </button>
            </div>

            <div class="modal-map-container">
              <div id="modalMap" aria-label="Mapa para selecionar localização do novo sítio"></div>
            </div>

            <div class="coordinates-info" id="coordinatesInfo">
              Clique em "Clicar no Mapa" e depois clique no mapa para selecionar a localização
            </div>

            <div class="form-row coordinates-input">
              <div class="form-group">
                <label for="itemLat">Latitude *</label>
                <input type="number" id="itemLat" name="itemLat" required step="any" placeholder="Ex: -15.7942" min="-90" max="90">
              </div>
              <div class="form-group">
                <label for="itemLng">Longitude *</label>
                <input type="number" id="itemLng" name="itemLng" required step="any" placeholder="Ex: -47.8822" min="-180" max="180">
              </div>
            </div>
          </div>

          <div class="form-group">
            <label for="itemDescription">Descrição</label>
            <textarea id="itemDescription" name="itemDescription" placeholder="Descreva o sítio, descoberta ou informações relevantes..."></textarea>
          </div>

          <!-- Upload de imagem -->
          <div class="form-group">
            <label>Imagem do Local</label>

            <div class="upload-options">
              <div class="upload-option active" onclick="setImageSource('file')">
                <i class="fas fa-upload" aria-hidden="true"></i> Upload do Computador
              </div>
              <div class="upload-option" onclick="setImageSource('url')">
                <i class="fas fa-link" aria-hidden="true"></i> URL da Imagem
              </div>
            </div>

            <div id="fileUploadContainer">
              <div class="file-upload-container">
                <div class="file-input-wrapper">
                  <input type="file" id="itemImageFile" name="itemImageFile" accept="image/*" class="file-input" onchange="handleFileSelect(event)">
                  <label for="itemImageFile" class="file-input-button">
                    <i class="fas fa-cloud-upload-alt" aria-hidden="true"></i> Escolher Arquivo
                  </label>
                </div>
                <div class="file-name" id="fileName">Nenhum arquivo selecionado</div>
                <img id="imagePreview" class="image-preview" src="" alt="Pré-visualização da imagem selecionada">
              </div>
            </div>

            <div id="urlInputContainer" style="display: none;">
              <input type="url" id="itemImageUrl" name="itemImageUrl" placeholder="https://exemplo.com/imagem.jpg">
            </div>
          </div>

          <div class="form-group">
            <label for="itemSiteUrl">URL do Site (opcional)</label>
            <input type="url" id="itemSiteUrl" name="itemSiteUrl" placeholder="https://exemplo.com">
          </div>

          <div class="form-actions">
            <button type="button" class="btn btn-secondary" onclick="closeAddModal()">Cancelar</button>
            <button type="submit" class="btn btn-primary" id="submitBtn">Adicionar ao Mapa</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Seção de Pesquisa -->
    <section id="search" class="search-section" aria-labelledby="search-title">
      <div class="container search-container">
        <h1 class="search-title" id="search-title">Pesquisa Arqueológica Inteligente</h1>
        <p class="search-subtitle">Explore milhares de sítios, artefatos, museus e informações arqueológicas</p>

        <div class="search-box">
          <input type="text" class="search-input" id="searchInput" placeholder="Pesquisar arqueologia, sítios, artefatos, períodos..." aria-label="Pesquisar conteúdo arqueológico">
          <button class="search-button" id="searchButton" aria-label="Executar pesquisa">
            <i class="fas fa-search" aria-hidden="true"></i>
          </button>
          <div class="search-suggestions" id="searchSuggestions"></div>
        </div>

        <div class="search-examples" aria-label="Sugestões de pesquisa">
          Exemplos:
          <span onclick="fillSearch('Serra da Capivara')">Serra da Capivara</span> •
          <span onclick="fillSearch('Luzia')">Luzia</span> •
          <span onclick="fillSearch('Sambaqui')">Sambaqui</span> •
          <span onclick="fillSearch('Museu de Arqueologia')">Museu de Arqueologia</span>
        </div>

        <div class="search-advanced">
          <div class="search-advanced-toggle" onclick="toggleAdvancedSearch()" role="button" tabindex="0" aria-expanded="false" aria-controls="advancedOptions">
            <i class="fas fa-sliders-h" aria-hidden="true"></i> Opções avançadas
            <i class="fas fa-chevron-down" id="advancedToggleIcon" aria-hidden="true"></i>
          </div>
          <div class="search-advanced-options" id="advancedOptions" hidden>
            <div class="form-row">
              <div class="search-advanced-group">
                <label for="searchType">Tipo de conteúdo</label>
                <select id="searchType">
                  <option value="all">Todos os tipos</option>
                  <option value="sites">Sítios Arqueológicos</option>
                  <option value="artifacts">Artefatos</option>
                  <option value="museums">Museus</option>
                  <option value="structures">Estruturas</option>
                  <option value="areas">Áreas Protegidas</option>
                </select>
              </div>
              <div class="search-advanced-group">
                <label for="searchPeriod">Período</label>
                <select id="searchPeriod">
                  <option value="all">Todos os períodos</option>
                  <option value="Pleistoceno">Pleistoceno</option>
                  <option value="Holoceno">Holoceno</option>
                  <option value="Pré-colonial">Pré-colonial</option>
                  <option value="Colonial">Colonial</option>
                  <option value="Contemporâneo">Contemporâneo</option>
                </select>
              </div>
            </div>
            <div class="search-advanced-group">
              <label for="searchRegion">Região</label>
              <select id="searchRegion">
                <option value="all">Todas as regiões</option>
                <option value="Norte">Norte</option>
                <option value="Nordeste">Nordeste</option>
                <option value="Centro-Oeste">Centro-Oeste</option>
                <option value="Sudeste">Sudeste</option>
                <option value="Sul">Sul</option>
                <option value="Internacional">Internacional</option>
              </select>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Resultados da Pesquisa -->
    <section class="search-results" id="searchResults" aria-label="Resultados da pesquisa">
      <div class="container">
        <div class="results-header">
          <div class="results-count" id="resultsCount">0 resultados encontrados</div>
          <div class="results-filters" aria-label="Filtros de tipo de resultado">
            <div class="filter-option active" data-filter="all" tabindex="0">Todos</div>
            <div class="filter-option" data-filter="sites" tabindex="0">Sítios</div>
            <div class="filter-option" data-filter="artifacts" tabindex="0">Artefatos</div>
            <div class="filter-option" data-filter="museums" tabindex="0">Museus</div>
            <div class="filter-option" data-filter="structures" tabindex="0">Estruturas</div>
            <div class="filter-option" data-filter="areas" tabindex="0">Áreas</div>
          </div>
        </div>

        <!-- Resumo Inteligente -->
        <div id="intelligentSummary" class="intelligent-summary" style="display: none;">
          <div class="summary-header">
            <i class="fas fa-brain" aria-hidden="true"></i>
            <h2>Resumo Inteligente</h2>
          </div>
          <div class="summary-content" id="summaryContent"></div>
          <div class="summary-sources">
            <h4>Fontes consultadas:</h4>
            <div class="sources-list" id="summarySources"></div>
          </div>
          <div class="summary-tags" id="summaryTags"></div>
        </div>

        <div class="search-stats" id="searchStats"></div>

        <div class="search-sort">
          <label for="sortResults">Ordenar por:</label>
          <select id="sortResults" onchange="sortResults()">
            <option value="relevance">Relevância</option>
            <option value="name">Nome (A-Z)</option>
            <option value="name-desc">Nome (Z-A)</option>
            <option value="artifacts">Número de artefatos</option>
            <option value="period">Período</option>
          </select>
        </div>

        <div class="results-container" id="resultsContainer"></div>
        <div class="pagination" id="pagination"></div>
      </div>
    </section>

    <!-- Hero Section -->
    <section class="hero">
      <div class="container hero-content">
        <h1>Revolucionando a Pesquisa Arqueológica com Tecnologia</h1>
        <p>Integração avançada de sistemas geoespaciais, documentação digital e análise de dados para arqueologia do século XXI</p>
        <div class="hero-buttons">
          <a href="#map" class="btn btn-primary">Explorar Plataforma</a>
          <a href="#features" class="btn btn-secondary">Ver Recursos</a>
        </div>
      </div>
    </section>

    <!-- Seção Sobre -->
    <section id="sobre" class="saiba-mais-sobre">
      <div class="container">
        <h1>O que é arqueologia?</h1>
        <p>A Arqueologia é a ciência que estuda o passado humano, tanto antigo quanto recente, através da análise de vestígios materiais como objetos, ferramentas, construções e fósseis. Ela busca compreender as culturas e os modos de vida das populações antigas, utilizando trabalho de campo (escavações), análise laboratorial de materiais e divulgação do conhecimento produzido.</p>
      </div>
    </section>

    <!-- Seção do Mapa Interativo -->
    <section id="map" class="map-section" aria-labelledby="map-title">
      <div class="container">
        <div class="section-header">
          <h2 class="section-title" id="map-title">Mapa Arqueológico Interativo</h2>
          <p class="section-subtitle">Visualize, analise e documente sítios arqueológicos em tempo real com nossa plataforma geoespacial integrada</p>
        </div>

        <div class="map-container">
          <div
            id="archaeologicalMap"
            role="region"
            aria-label="Mapa arqueológico interativo com localização de sítios"
          ></div>

          <!-- Filtros do Mapa -->
          <div class="map-filters" aria-label="Filtros do mapa">
            <div class="filter-header">
              <h3><i class="fas fa-filter" aria-hidden="true"></i> Filtros</h3>
            </div>

            <div class="filter-group">
              <label for="filterType">Tipo de Sítio</label>
              <select id="filterType">
                <option value="all">Todos os Tipos</option>
                <option value="Sítio em Escavação">Sítio em Escavação</option>
                <option value="Sítio Documentado">Sítio Documentado</option>
                <option value="Área Protegida">Área Protegida</option>
                <option value="Artefato Registrado">Artefato Registrado</option>
                <option value="Estrutura Arqueológica">Estrutura Arqueológica</option>
                <option value="Museus Arqueológicos">Museu Arqueológico</option>
              </select>
            </div>

            <div class="filter-group">
              <label for="filterPeriod">Período</label>
              <select id="filterPeriod">
                <option value="all">Todos os Períodos</option>
                <option value="Pleistoceno">Pleistoceno</option>
                <option value="Holoceno">Holoceno</option>
                <option value="Pré-colonial">Pré-colonial</option>
                <option value="Colonial">Colonial</option>
                <option value="Contemporâneo">Contemporâneo</option>
              </select>
            </div>

            <div class="filter-actions">
              <button class="filter-btn" onclick="applyFilters()">Aplicar Filtros</button>
              <button class="filter-btn secondary" onclick="resetFilters()">Limpar</button>
            </div>
          </div>

          <!-- Legenda do Mapa -->
          <div class="map-overlay" aria-label="Legenda do mapa">
            <div class="legend-header">
              <h3><i class="fas fa-layer-group" aria-hidden="true"></i> Legenda do Mapa</h3>
              <button class="toggle-button" onclick="toggleLegend()" aria-controls="legendContent" aria-expanded="true">-</button>
            </div>

            <div class="map-legend" id="legendContent">
              <div class="legend-item">
                <div class="legend-color" style="background-color: #e74c3c;"></div>
                <span>Sítio em Escavação</span>
              </div>
              <div class="legend-item">
                <div class="legend-color" style="background-color: #3498db;"></div>
                <span>Sítio Documentado</span>
              </div>
              <div class="legend-item">
                <div class="legend-color" style="background-color: #2ecc71;"></div>
                <span>Área Protegida</span>
              </div>
              <div class="legend-item">
                <div class="legend-color" style="background-color: #f39c12;"></div>
                <span>Artefato Registrado</span>
              </div>
              <div class="legend-item">
                <div class="legend-color" style="background-color: #9b59b6;"></div>
                <span>Estrutura Arqueológica</span>
              </div>
              <div class="legend-item">
                <div class="legend-color" style="background-color: #f1c40f;"></div>
                <span>Museus Arqueológicos</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Seção de Recursos -->
    <section id="features" class="features-section">
      <div class="container">
        <div class="section-header">
          <h2 class="section-title">Tecnologia Arqueológica Avançada</h2>
          <p class="section-subtitle">Ferramentas especializadas desenvolvidas para pesquisadores e equipes de campo</p>
        </div>

        <div class="features-grid">
          <div class="feature-card">
            <div class="feature-icon">
              <i class="fas fa-map-marked-alt" aria-hidden="true"></i>
            </div>
          <div class="feature-card">
            <div class="feature-icon">
              <i class="fas fa-layer-group" aria-hidden="true"></i>
            </div>
            <h3>Gestão Estratigráfica</h3>
            <p>Documentação automatizada de camadas com registro fotográfico e descritivo.</p>
            <a href="#" class="feature-link"><i class="fas fa-arrow-right" aria-hidden="true"></i></a>
          </div>

          <div class="feature-card">
            <div class="feature-icon">
              <i class="fas fa-database" aria-hidden="true"></i>
            </div>
            <h3>Banco de Dados Integrado</h3>
            <p>Armazenamento seguro e organização inteligente de todos os dados arqueológicos.</p>
            <a href="#" class="feature-link"><i class="fas fa-arrow-right" aria-hidden="true"></i></a>
          </div>

          <div class="feature-card">
            <div class="feature-icon">
              <i class="fas fa-search" aria-hidden="true"></i>
            </div>
            <h3>Pesquisa Inteligente</h3>
            <p>Busca avançada com informações de fontes confiáveis e resumos automáticos.</p>
            <a href="#search" class="feature-link">Testar agora <i class="fas fa-arrow-right" aria-hidden="true"></i></a>
          </div>
        </div>
      </div>
    </section>

    <!-- Seção CTA -->
    <section class="cta-section">
      <div class="container">
        <div class="cta-content">
          <h2 style="margin-bottom: 1rem;">Pronto para revolucionar sua pesquisa arqueológica?</h2>
          <p style="margin-bottom: 2rem;">Junte-se a centenas de pesquisadores que já utilizam nossa plataforma para documentação, análise e gestão de dados arqueológicos.</p>
          <a href="#contact" class="btn btn-primary">Solicitar Demonstração</a>
        </div>
      </div>
    </section>
  </main>

  <!-- Footer -->
  <footer id="contact" role="contentinfo">
    <div class="container">
      <div class="footer-content">
        <div class="footer-column footer-about">
          <h3>Archaeology World</h3>
          <p>Soluções tecnológicas avançadas para pesquisa e gestão do patrimônio arqueológico. Integrando conhecimento tradicional com inovação digital.</p>
          <div class="footer-social" aria-label="Redes sociais da Archaeology World">
            <a href="#"><i class="fab fa-twitter" aria-hidden="true"></i><span class="sr-only">Twitter</span></a>
            <a href="#"><i class="fab fa-linkedin" aria-hidden="true"></i><span class="sr-only">LinkedIn</span></a>
            <a href="#"><i class="fab fa-researchgate" aria-hidden="true"></i><span class="sr-only">ResearchGate</span></a>
            <a href="#"><i class="fab fa-youtube" aria-hidden="true"></i><span class="sr-only">YouTube</span></a>
          </div>
        </div>

        <div class="footer-column footer-links">
          <h3>Recursos</h3>
          <ul>
            <li><a href="#">Documentação Técnica</a></li>
            <li><a href="#">Tutoriais em Vídeo</a></li>
            <li><a href="#">Banco de Dados Público</a></li>
            <li><a href="#">Publicações Científicas</a></li>
          </ul>
        </div>

        <div class="footer-column footer-contact">
          <h3>Contato</h3>
          <p><i class="fas fa-map-marker-alt" aria-hidden="true"></i> Av. Arqueologia, 123 - Centro</p>
          <p><i class="fas fa-phone" aria-hidden="true"></i> (11) 98765-4321</p>
          <p><i class="fas fa-envelope" aria-hidden="true"></i> contato.archaeologyworld@gmail.com</p>
        </div>
      </div>

      <div class="footer-bottom">
        <p>&copy; 2024 Archaeology World. Todos os direitos reservados.</p>
        <p>Desenvolvido com paixão pela arqueologia e tecnologia.</p>
      </div>
    </div>
  </footer>


    <script src="/lib/leaflet/leaflet.js"></script>
    <script>
    
      // ===== SISTEMA DE APRENDIZADO POR REFORÇO (APRIMORADO) ===== //
class SimpleReinforcementLearning {
    constructor() {
        // Estrutura: { query: { itemId: { score, interactions[] } } }
        const stored = localStorage.getItem('archaeologyRL');
        this.learningData = stored ? JSON.parse(stored) : {};
    }

    // Normaliza a consulta para evitar chaves duplicadas
    normalizeQuery(query) {
        return (query || '')
            .toLowerCase()
            .trim()
            .replace(/\s+/g, ' ');
    }

    // Garante a estrutura interna para a query + item
    ensureEntry(query, itemId) {
        const q = this.normalizeQuery(query);
        const id = itemId || 'unknown_item';

        if (!this.learningData[q]) {
            this.learningData[q] = {};
        }
        if (!this.learningData[q][id]) {
            this.learningData[q][id] = {
                score: 0,
                interactions: []
            };
        }
        return { q, id };
    }

    // Registrar uma interação
    recordInteraction(query, itemId, interactionType, data = {}) {
        const { q, id } = this.ensureEntry(query, itemId);

        let points = 0;
        switch (interactionType) {
            case 'click':
                points = 2;
                break;
            case 'time_spent':
                points = Math.min((data.seconds || 0) / 30, 3); // Máx 3 pts
                break;
            case 'save':
                points = 5;
                break;
            case 'share':
                points = 4;
                break;
            case 'search':
                points = Math.min((data.resultsCount || 0) / 50, 2);
                break;
            case 'negative':
                points = -2;
                break;
            default:
                points = 1;
        }

        const entry = this.learningData[q][id];
        entry.score += points;
        entry.interactions.push({
            type: interactionType,
            points,
            timestamp: new Date().toISOString(),
            data
        });

        // Mantém apenas as últimas 100 interações por item
        if (entry.interactions.length > 100) {
            entry.interactions = entry.interactions.slice(-100);
        }

        this.saveData();
    }

    // Obter pontuação "ponderada" para um item (dá mais peso para interações recentes)
    getScore(query, itemId) {
        const q = this.normalizeQuery(query);
        const id = itemId || 'unknown_item';

        if (!this.learningData[q] || !this.learningData[q][id]) {
            return 0;
        }

        const entry = this.learningData[q][id];
        if (!entry.interactions || entry.interactions.length === 0) {
            return entry.score || 0;
        }

        const now = Date.now();
        const MS_PER_DAY = 24 * 60 * 60 * 1000;
        let weightedScore = 0;

        // Decaimento suave: interações muito antigas pesam menos
        entry.interactions.forEach(inter => {
            const t = new Date(inter.timestamp).getTime();
            const deltaDays = (now - t) / MS_PER_DAY;
            const weight = Math.exp(-deltaDays / 60); // meia-vida ~ 40–60 dias
            weightedScore += inter.points * weight;
        });

        return weightedScore;
    }

    // Ajustar relevância baseado no aprendizado
    adjustRelevance(query, results) {
        const q = this.normalizeQuery(query);

        return results
            .map(result => {
                const itemId = result.id || result.title || 'unknown_item';
                const score = this.getScore(q, itemId);

                // Normaliza score e limita aumento máximo em ~25%
                const capped = Math.min(Math.abs(score), 20); // corta extremos
                const normalized = capped / 20;               // 0–1
                const direction = score >= 0 ? 1 : -1;
                const boost = direction * normalized * 0.25;  // máx ±0.25

                const baseRel = typeof result.relevance === 'number'
                    ? result.relevance
                    : 0.5;

                return {
                    ...result,
                    relevance: baseRel + boost
                };
            })
            .sort((a, b) => (b.relevance || 0) - (a.relevance || 0));
    }

    // Salvar dados
    saveData() {
        localStorage.setItem('archaeologyRL', JSON.stringify(this.learningData));
    }

    // Obter estatísticas globais do aprendizado
    getStats() {
        const queries = Object.keys(this.learningData);
        let totalInteractions = 0;
        let totalScore = 0;
        let mostActiveQuery = null;
        let mostActiveCount = 0;
        let lastInteractionAt = null;

        queries.forEach(query => {
            const items = Object.keys(this.learningData[query]);
            let queryInteractions = 0;

            items.forEach(itemId => {
                const entry = this.learningData[query][itemId];
                const count = entry.interactions.length;
                queryInteractions += count;
                totalInteractions += count;
                totalScore += entry.score;

                if (count > 0) {
                    const last = entry.interactions[entry.interactions.length - 1].timestamp;
                    if (!lastInteractionAt || last > lastInteractionAt) {
                        lastInteractionAt = last;
                    }
                }
            });

            if (queryInteractions > mostActiveCount) {
                mostActiveCount = queryInteractions;
                mostActiveQuery = query;
            }
        });

        return {
            totalQueries: queries.length,
            totalInteractions,
            totalScore,
            averageScorePerQuery: queries.length > 0 ? totalScore / queries.length : 0,
            mostActiveQuery: mostActiveQuery || null,
            mostActiveQueryInteractions: mostActiveCount,
            lastInteractionAt
        };
    }
}


// ===== DICIONÁRIO DE SINÔNIMOS (APRIMORADO) ===== //
const synonymDictionary = {
    ceramica: [
        'cerâmica', 'vaso', 'pote', 'urna', 'recipiente', 'louça',
        'prato', 'tigela'
    ],
    litico: [
        'lítico', 'ferramenta de pedra', 'pedra lascada',
        'instrumento lítico', 'lascas', 'machado de pedra'
    ],
    sambaqui: [
        'sambaqui', 'concheiro', 'monte de conchas',
        'sítio conchífero'
    ],
    rupestre: [
        'rupestre', 'pintura rupestre', 'gravura rupestre',
        'arte rupestre', 'painel rupestre'
    ],
    indigena: [
        'indígena', 'nativo', 'ameríndio', 'povo originário'
    ],
    colonial: [
        'colonial', 'colônia', 'período colonial', 'era colonial'
    ],
    'pre-colonial': [
        'pré-colonial', 'pré-colombiano', 'pré-histórico'
    ],
    escavacao: [
        'escavação', 'escavar', 'excavar', 'sondagem',
        'trincheira', 'unidade de escavação'
    ],
    artefato: [
        'artefato', 'objeto', 'utensílio', 'instrumento',
        'peça arqueológica'
    ],
    sitio: [
        'sítio', 'local', 'área', 'jazida', 'sítio arqueológico'
    ],
    arqueologia: [
        'arqueologia', 'arqueológico', 'arqueóloga', 'arqueólogo'
    ],
    museu: [
        'museu', 'museológico', 'acervo', 'coleção'
    ],
    pesquisa: [
        'pesquisa', 'estudo', 'investigação', 'projeto',
        'levantamento', 'prospecção'
    ],
    ossos: [
        'osso', 'ossos', 'restos ósseos', 'esqueletos'
    ],
    funerario: [
        'funerário', 'sepultamento', 'túmulo', 'enterro',
        'cemitério arqueológico'
    ]
};

// Helpers opcionais para você usar na expansão de consulta:

// Normaliza texto para comparação de sinônimos
function normalizeForSynonyms(text) {
    return (text || '')
        .toLowerCase()
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '')
        .replace(/ç/g, 'c');
}

// Expande uma consulta usando o dicionário de sinônimos
function expandQueryWithSynonyms(query) {
    const norm = normalizeForSynonyms(query);
    const tokens = norm.split(/\s+/).filter(Boolean);
    const expansions = new Set([query]);

    Object.entries(synonymDictionary).forEach(([key, syns]) => {
        if (tokens.includes(key)) {
            syns.forEach(syn => {
                expansions.add(`${query} ${syn}`);
            });
        }
    });

    return Array.from(expansions);
}

    // ===== SISTEMA DE DETECÇÃO DE INTENÇÃO (APRIMORADO) ===== //
class QueryIntentDetector {
    detectIntent(query) {
        const normalized = (query || '').toLowerCase();

        const intents = {
            isWhat: /(o que é|oque é|o que são|o que sao|definiç|definicao|conceito|significa)/.test(normalized),
            isHow: /(como|funciona|processo|técnica|tecnica|método|metodo|metodologia)/.test(normalized),
            isWhere: /(onde|local|regi[aã]o|regiao|encontrar|localizaç|localizacao|fica)/.test(normalized),
            isWhen: /(quando|período|periodo|data|época|epoca|cronologia)/.test(normalized),
            isWhy: /(por que|porque|raz[aã]o|razao|causa|motivo|import[aâ]ncia|importancia|relev[aâ]ncia|relevancia)/.test(normalized),
            isWho: /(quem|pesquisador|arque[oó]logo|arqueologo|descobridor|equipe|instituiç|instituicao)/.test(normalized),
            isCompare: /(diferença|diferenca|comparar|vs\.|vs |versus|semelhança|semelhanca)/.test(normalized),
            isList: /(lista|exemplos|exemplo|tipos|quais|principais)/.test(normalized)
        };

        // Pode haver mais de uma intenção; aplica prioridades simples
        const detected = Object.keys(intents).filter(k => intents[k]);

        if (detected.length === 0) return 'general';
        if (detected.length === 1) return detected[0];

        // Prioridades: comparação > lista > por quê > como > o que > resto
        const priorityOrder = [
            'isCompare',
            'isList',
            'isWhy',
            'isHow',
            'isWhat',
            'isWhere',
            'isWhen',
            'isWho'
        ];

        for (const intent of priorityOrder) {
            if (detected.includes(intent)) return intent;
        }

        // Fallback
        return detected[0];
    }
}


// ===== SISTEMA DE RESPOSTAS POR INTENÇÃO (APRIMORADO) ===== //
class IntentBasedResponse {

    generateByIntent(intent, themeData, results, query) {
        const generators = {
            isWhat: this.generateDefinitionResponse,
            isHow: this.generateProcessResponse,
            isWhere: this.generateLocationResponse,
            isWhen: this.generateTimelineResponse,
            isWhy: this.generateSignificanceResponse,
            isWho: this.generateResearchersResponse,
            isCompare: this.generateComparisonResponse,
            isList: this.generateListResponse,
            general: this.generateGeneralResponse
        };

        const handler = generators[intent] || generators.general;
        return handler.call(this, themeData, results || [], query || '');
    }

    // ===== Utilitários internos ===== //

    buildResultsStats(results) {
        const stats = {
            total: results.length,
            sites: 0,
            themes: 0,
            periods: new Set(),
            types: new Set(),
            exampleSites: []
        };

        results.forEach(r => {
            if (r.isSite && r.siteData) {
                stats.sites++;
                if (stats.exampleSites.length < 5) stats.exampleSites.push(r);
            }
            if (r.isTheme) stats.themes++;
            if (r.period) stats.periods.add(r.period);
            if (r.type) stats.types.add(r.type);
        });

        return {
            ...stats,
            periodsArray: Array.from(stats.periods),
            typesArray: Array.from(stats.types)
        };
    }

    buildQuickFacts(themeData, stats) {
        const baseFacts = Array.isArray(themeData.keyFacts) ? [...themeData.keyFacts] : [];

        if (stats.total > 0) {
            baseFacts.push(`🔎 A pesquisa retornou ${stats.total} resultado(s) diretamente relacionado(s) ao tema.`);
        }
        if (stats.sites > 0) {
            baseFacts.push(`📍 Foram identificados ${stats.sites} sítio(s) arqueológico(s) associado(s) ao tema nesta busca.`);
        }
        if (stats.periodsArray.length > 0) {
            baseFacts.push(`⏳ Principais períodos representados: ${stats.periodsArray.join(', ')}.`);
        }
        if (stats.typesArray.length > 0) {
            baseFacts.push(`🧩 Tipos de conteúdo encontrados: ${stats.typesArray.join(', ')}.`);
        }

        return baseFacts;
    }

    // ===== Geradores por intenção ===== //

    generateDefinitionResponse(themeData, results, query) {
        const stats = this.buildResultsStats(results);
        const quickFacts = this.buildQuickFacts(themeData, stats);

        return `
            <div class="definition-response intent-response">
                <div class="intent-header">
                    <div class="intent-icon">📚</div>
                    <h2 class="intent-title">${themeData.title} – Definição e contexto</h2>
                </div>
                <p><strong>Conceito central:</strong> ${themeData.baseDescription}</p>
                ${quickFacts.length ? `
                <div class="quick-facts">
                    <h3>📋 Resumo informativo</h3>
                    <ul>
                        ${quickFacts.slice(0, 6).map(f => `<li>${f}</li>`).join('')}
                    </ul>
                </div>` : ''}
                ${themeData.significance ? `
                <div class="significance">
                    <h3>🎯 Por que é importante?</h3>
                    <p>${themeData.significance}</p>
                </div>` : ''}
            </div>
        `;
    }

    generateLocationResponse(themeData, results, query) {
        const stats = this.buildResultsStats(results);
        const siteResults = stats.exampleSites;

        return `
            <div class="location-response intent-response">
                <div class="intent-header">
                    <div class="intent-icon">📍</div>
                    <h2 class="intent-title">${themeData.title} – Localização e distribuição</h2>
                </div>
                <p><strong>Distribuição geográfica geral:</strong> ${this.extractLocationInfo(themeData)}</p>
                ${stats.sites > 0 ? `
                <div class="quick-facts">
                    <h3>🌎 Visão rápida</h3>
                    <ul>
                        <li>Foram encontrados ${stats.sites} sítio(s) arqueológico(s) associado(s) ao tema nesta busca.</li>
                        ${stats.periodsArray.length ? `<li>Períodos representados: ${stats.periodsArray.join(', ')}.</li>` : ''}
                    </ul>
                </div>` : ''}
                ${siteResults.length ? `
                <div class="sites-list">
                    <h3>🏺 Sítios relacionados (clique nos resultados para focar no mapa)</h3>
                    <ul>
                        ${siteResults.map(site => `
                            <li>
                                <strong>${site.title}</strong>
                                ${site.siteData.coords
                                    ? ` – Coords: ${site.siteData.coords[0].toFixed(2)}, ${site.siteData.coords[1].toFixed(2)}`
                                    : ' – Localização documentada'}
                                ${site.period ? ` – Período: ${site.period}` : ''}
                            </li>
                        `).join('')}
                    </ul>
                </div>` : ''}
            </div>
        `;
    }

    generateTimelineResponse(themeData, results, query) {
        const stats = this.buildResultsStats(results);

        return `
            <div class="intent-response">
                <div class="intent-header">
                    <div class="intent-icon">⏳</div>
                    <h2 class="intent-title">${themeData.title} – Linha do tempo arqueológica</h2>
                </div>
                <p>${themeData.baseDescription}</p>
                <div class="key-facts">
                    <h3>📆 Principais marcos temporais</h3>
                    <ul>
                        ${stats.periodsArray.length
                            ? `<li>Períodos mais recorrentes nos resultados: ${stats.periodsArray.join(', ')}.</li>`
                            : '<li>Os resultados abrangem diferentes períodos, variando conforme o contexto de cada sítio.</li>'}
                        ${themeData.currentResearch
                            ? `<li>Pesquisas atuais focam em: ${themeData.currentResearch}.</li>`
                            : ''}
                    </ul>
                </div>
                ${themeData.significance ? `
                <div class="significance">
                    <h3>🎯 Importância cronológica</h3>
                    <p>${themeData.significance}</p>
                </div>` : ''}
            </div>
        `;
    }

    generateProcessResponse(themeData, results, query) {
        const stats = this.buildResultsStats(results);

        return `
            <div class="intent-response">
                <div class="intent-header">
                    <div class="intent-icon">🛠️</div>
                    <h2 class="intent-title">${themeData.title} – Métodos e técnicas</h2>
                </div>
                <p>${themeData.baseDescription}</p>
                <div class="key-facts">
                    <h3>🔬 Como se estuda este tema?</h3>
                    <ul>
                        ${themeData.researchMethods
                            ? `<li>Métodos principais: ${themeData.researchMethods}.</li>`
                            : '<li>Envolve métodos de escavação, registro estratigráfico e análises laboratoriais específicas ao contexto.</li>'}
                        ${themeData.materialCulture
                            ? `<li>Cultura material associada: ${themeData.materialCulture}.</li>`
                            : ''}
                        <li>Na sua busca, foram identificados ${stats.total} resultado(s), incluindo ${stats.sites} sítios com dados geoespaciais.</li>
                    </ul>
                </div>
            </div>
        `;
    }

    generateSignificanceResponse(themeData, results, query) {
        const stats = this.buildResultsStats(results);

        return `
            <div class="intent-response">
                <div class="intent-header">
                    <div class="intent-icon">🎯</div>
                    <h2 class="intent-title">${themeData.title} – Relevância e interpretação</h2>
                </div>
                <p>${themeData.baseDescription}</p>
                ${themeData.significance ? `
                <div class="significance">
                    <h3>Por que este tema é importante?</h3>
                    <p>${themeData.significance}</p>
                </div>` : ''}
                ${themeData.controversies ? `
                <div class="controversies">
                    <h3>🔥 Debates e controvérsias</h3>
                    <p>${themeData.controversies}</p>
                </div>` : ''}
                <div class="key-facts">
                    <h3>📊 Visão a partir da sua busca</h3>
                    <ul>
                        <li>${stats.total} resultado(s) relacionados, com ${stats.sites} sítios mapeados.</li>
                        ${stats.typesArray.length ? `<li>Tipos de registro: ${stats.typesArray.join(', ')}.</li>` : ''}
                    </ul>
                </div>
            </div>
        `;
    }

    generateResearchersResponse(themeData, results, query) {
        const stats = this.buildResultsStats(results);

        return `
            <div class="intent-response">
                <div class="intent-header">
                    <div class="intent-icon">👩‍🔬</div>
                    <h2 class="intent-title">${themeData.title} – Pesquisadores e instituições</h2>
                </div>
                <p>${themeData.baseDescription}</p>
                <div class="key-facts">
                    <h3>Quem pesquisa este tema?</h3>
                    <ul>
                        ${themeData.keyFacts
                            ? themeData.keyFacts
                                .filter(f => f.toLowerCase().includes('pesquisador')
                                    || f.toLowerCase().includes('instituto')
                                    || f.toLowerCase().includes('museu'))
                                .map(f => `<li>${f}</li>`).join('') || '<li>Pesquisadores e instituições variam conforme a região e o período estudado.</li>'
                            : '<li>Pesquisadores e instituições variam conforme a região e o período estudado.</li>'}
                        <li>Sua busca retornou ${stats.total} registro(s) potencialmente ligados a equipes de pesquisa distintas.</li>
                    </ul>
                </div>
            </div>
        `;
    }

    generateComparisonResponse(themeData, results, query) {
        const stats = this.buildResultsStats(results);

        return `
            <div class="intent-response">
                <div class="intent-header">
                    <div class="intent-icon">⚖️</div>
                    <h2 class="intent-title">${themeData.title} – Comparações e diferenças</h2>
                </div>
                <p>${themeData.baseDescription}</p>
                <div class="key-facts">
                    <h3>Pontos para comparar</h3>
                    <ul>
                        <li>Use os filtros de tipo, período e região para comparar contextos arqueológicos semelhantes.</li>
                        ${stats.periodsArray.length ? `<li>Períodos presentes nos resultados: ${stats.periodsArray.join(', ')}.</li>` : ''}
                        ${stats.typesArray.length ? `<li>Tipos de registro encontrados: ${stats.typesArray.join(', ')}.</li>` : ''}
                    </ul>
                </div>
            </div>
        `;
    }

    generateListResponse(themeData, results, query) {
        const stats = this.buildResultsStats(results);

        return `
            <div class="intent-response">
                <div class="intent-header">
                    <div class="intent-icon">📑</div>
                    <h2 class="intent-title">${themeData.title} – Lista de exemplos</h2>
                </div>
                <p>${themeData.baseDescription}</p>
                <div class="key-facts">
                    <h3>Exemplos a partir da sua busca</h3>
                    <ul>
                        ${stats.exampleSites.length
                            ? stats.exampleSites.map(s => `<li>${s.title}${s.period ? ` – ${s.period}` : ''}</li>`).join('')
                            : '<li>Use termos mais específicos (região, período ou tipo de sítio) para ver uma lista mais focada.</li>'}
                    </ul>
                </div>
            </div>
        `;
    }

    generateGeneralResponse(themeData, results, query) {
        const stats = this.buildResultsStats(results);

        return `
            <div class="enhanced-response intent-response">
                <div class="intent-header">
                    <div class="intent-icon">📖</div>
                    <h2 class="intent-title">${themeData.title}</h2>
                </div>
                <div class="response-main">
                    <p>${themeData.baseDescription}</p>
                </div>

                ${themeData.keyFacts ? `
                <div class="key-facts">
                    <h3>📊 Fatos principais</h3>
                    <ul>
                        ${themeData.keyFacts.map(fact => `<li>${fact}</li>`).join('')}
                        <li>Na sua pesquisa, o sistema encontrou ${stats.total} resultado(s), incluindo ${stats.sites} sítios e ${stats.themes} tema(s) relacionados.</li>
                    </ul>
                </div>` : ''}

                ${themeData.significance ? `
                <div class="significance">
                    <h3>🎯 Significado arqueológico</h3>
                    <p>${themeData.significance}</p>
                </div>` : ''}

                ${themeData.currentResearch ? `
                <div class="external-info">
                    <h3>🔬 Pesquisas atuais</h3>
                    <p>${themeData.currentResearch}</p>
                </div>` : ''}

                ${themeData.controversies ? `
                <div class="controversies">
                    <h3>🔥 Debates acadêmicos</h3>
                    <p>${themeData.controversies}</p>
                </div>` : ''}
            </div>
        `;
    }

    // ===== Localização heurística por título ===== //
    extractLocationInfo(themeData) {
        const title = (themeData.title || '').toLowerCase();

        if (title.includes('serra da capivara')) {
            return 'Região do Piauí (Nordeste do Brasil), principalmente no Parque Nacional Serra da Capivara.';
        } else if (title.includes('sambaqui')) {
            return 'Litoral brasileiro, com maior concentração nas regiões Sul e Sudeste.';
        } else if (title.includes('marajó') || title.includes('marajoara')) {
            return 'Ilha de Marajó, na foz do rio Amazonas (estado do Pará).';
        }

        return 'A distribuição espacial varia conforme período, cultura e contexto arqueológico específicos.';
    }
}
       // ===== SISTEMA HÍBRIDO DE RESPOSTAS (VERSÃO AVANÇADA) ===== //
class HybridResponseSystem {
    /**
     * @param {Object} options
     *   options.logger?: função para log (ex: console.log)
     */
    constructor(options = {}) {
        this.intentDetector = new QueryIntentDetector();
        this.responseGenerator = new IntentBasedResponse();
        this.rlSystem = new SimpleReinforcementLearning();
        this.cache = new Map(); // cache de respostas HTML
        this.logger = typeof options.logger === 'function' ? options.logger : null;
    }

    log(...args) {
        if (this.logger) this.logger('[HybridResponseSystem]', ...args);
    }

    /**
     * Normaliza a query para chaves e comparações internas.
     */
    normalizeQuery(query) {
        return (query || '')
            .toLowerCase()
            .trim()
            .replace(/\s+/g, ' ');
    }

    /**
     * Define uma chave de cache levando em conta consulta, intenção, tema e filtros.
     */
    buildCacheKey(query, intent, themeKey, filters = {}) {
        return JSON.stringify({
            q: this.normalizeQuery(query),
            intent,
            themeKey: themeKey || null,
            type: filters.type || 'all',
            period: filters.period || 'all',
            region: filters.region || 'all'
        });
    }

    /**
     * Escolhe o melhor tema da base para a consulta, se o tema não vier explícito.
     * Retorna { theme, key, score, reason }.
     */
    resolveTheme(query, explicitThemeData = null) {
        if (explicitThemeData) {
            return {
                theme: explicitThemeData,
                key: null,
                score: 1,
                reason: 'Tema explícito fornecido pela aplicação.'
            };
        }

        const q = this.normalizeQuery(query);
        let bestKey = null;
        let bestScore = 0;

        Object.entries(enhancedThemeDatabase).forEach(([key, theme]) => {
            let score = 0;

            const title = (theme.title || '').toLowerCase();
            if (title) {
                if (q === title) score += 4;
                else if (q.includes(title) || title.includes(q)) score += 2;
            }

            (theme.keywords || []).forEach(kw => {
                const k = kw.toLowerCase();
                if (q === k) score += 3;
                else if (q.includes(k)) score += 1.5;
                else if (k.includes(q)) score += 0.75;
            });

            if (theme.period && q.includes(theme.period.toLowerCase())) score += 1;
            if (theme.region && q.includes(theme.region.toLowerCase())) score += 1;
            if (theme.type && q.includes(theme.type.toLowerCase())) score += 0.5;

            if (score > bestScore) {
                bestScore = score;
                bestKey = key;
            }
        });

        if (!bestKey) {
            // Tema genérico
            return {
                theme: {
                    title: query || 'Tema arqueológico',
                    baseDescription: 'Tema arqueológico relacionado à sua busca.',
                    keyFacts: [],
                    significance: null,
                    currentResearch: null,
                    controversies: null
                },
                key: null,
                score: 0,
                reason: 'Nenhuma entrada da base se destacou; usando tema genérico com a própria consulta.'
            };
        }

        const theme = enhancedThemeDatabase[bestKey];
        return {
            theme,
            key: bestKey,
            score: bestScore,
            reason: `Tema "${theme.title}" escolhido com base em título/palavras‑chave/atributos que mais combinaram com a consulta.`
        };
    }

    /**
     * Gera resposta HTML rica + metadados sobre a decisão da IA.
     * Retorna objeto:
     * {
     *   html,
     *   intent,
     *   themeKey,
     *   themeTitle,
     *   debug: { reason, score, filters, totalResults }
     * }
     */
    async generateEnhancedResponse(query, themeData, searchResults, filters = {}) {
        const safeQuery = query || '';
        const normalizedQuery = this.normalizeQuery(safeQuery);
        const intent = this.intentDetector.detectIntent(safeQuery);
        const resolved = this.resolveTheme(safeQuery, themeData);

        const key = this.buildCacheKey(safeQuery, intent, resolved.key, filters);

        if (this.cache.has(key)) {
            this.log && this.log('Resposta do cache para', key);
            return this.cache.get(key);
        }

        const resultsArray = Array.isArray(searchResults) ? searchResults : [];

        // Registrar interação de busca no sistema de reforço
        this.rlSystem.recordInteraction(
            safeQuery,
            'search_query',
            'search',
            { resultsCount: resultsArray.length }
        );

        const html = this.responseGenerator.generateByIntent(
            intent,
            resolved.theme,
            resultsArray,
            safeQuery
        );

        const payload = {
            html,
            intent,
            themeKey: resolved.key,
            themeTitle: resolved.theme.title,
            debug: {
                reason: resolved.reason,
                score: resolved.score,
                filters: {
                    type: filters.type || 'all',
                    period: filters.period || 'all',
                    region: filters.region || 'all'
                },
                totalResults: resultsArray.length,
                normalizedQuery
            }
        };

        this.cache.set(key, payload);
        this.log && this.log('Gerada nova resposta e armazenada em cache', payload.debug);
        return payload;
    }

    // Exposto para registrar cliques, tempo de leitura, salvar etc.
    recordUserInteraction(query, itemId, interactionType, data = {}) {
        this.rlSystem.recordInteraction(query || '', itemId, interactionType, data);
        this.log && this.log('Interação registrada', { query, itemId, interactionType, data });
    }

    // Expor estatísticas do aprendizado
    getLearningStats() {
        const stats = this.rlSystem.getStats();
        this.log && this.log('Estatísticas de aprendizado', stats);
        return stats;
    }
}


// ===== EXPANSÃO DA BASE DE CONHECIMENTO (APRIMORADA) ===== //
const enhancedThemeDatabase = {
    serra_capivara: {
        title: "Parque Nacional Serra da Capivara",
        baseDescription: "Complexo de sítios com arte rupestre no sudeste do Piauí, fundamental para a discussão sobre a antiguidade da presença humana nas Américas.",
        keyFacts: [
            "📍 Localização: Sudeste do Piauí, Brasil",
            "📅 Período: Pleistoceno–Holoceno",
            "🎨 Centenas de painéis de arte rupestre em abrigos sob rocha.",
            "🏛️ Grande número de sítios escavados e mapeados.",
            "🌍 Reconhecido como Patrimônio Mundial."
        ],
        significance: "Um dos conjuntos de sítios rupestres mais relevantes do mundo, com forte impacto em modelos de povoamento da América do Sul.",
        currentResearch: "Estudos de datação, iconografia, uso da paisagem e conservação.",
        controversies: "Debates sobre datações muito recuadas e sua compatibilidade com outros registros arqueológicos.",
        period: "Pleistoceno–Holoceno",
        region: "Nordeste",
        type: "região arqueológica",
        keywords: [
            "serra da capivara",
            "parque nacional serra da capivara",
            "arte rupestre piauí",
            "pinturas rupestres brasil"
        ],
        sources: [
            { name: "IPHAN", url: "http://portal.iphan.gov.br/" },
            { name: "UNESCO", url: "https://whc.unesco.org/en/list/606" }
        ]
    },

    sambaqui: {
        title: "Sambaquis – Sítios Conchíferos",
        baseDescription: "Montes artificiais formados por conchas, sedimentos e vestígios orgânicos, construídos por grupos costeiros ao longo de milhares de anos.",
        keyFacts: [
            "🐚 Compostos por conchas, restos faunísticos, sedimentos e, muitas vezes, sepultamentos.",
            "📅 Principalmente Holoceno médio e tardio.",
            "📍 Predominam no litoral Sul e Sudeste do Brasil.",
            "⚰️ Funções múltiplas: habitação, funerária e territorial."
        ],
        significance: "Centrais para entender adaptações a ambientes costeiros, dieta baseada em recursos marinhos e organização social complexa.",
        materialCulture: "Instrumentos ósseos, artefatos líticos, restos humanos e cerâmicas tardias.",
        researchMethods: "Escavações em quadrícula, datação radiocarbônica, análises isotópicas e zooarqueológicas.",
        period: "Holoceno",
        region: "Litoral",
        type: "tipo de sítio",
        keywords: [
            "sambaqui",
            "sambaquis",
            "sítio conchífero",
            "monte de conchas",
            "povos sambaquieiros"
        ],
        sources: [
            { name: "Museu Nacional", url: "https://www.museunacional.ufrj.br" },
            { name: "IPHAN", url: "http://portal.iphan.gov.br/" }
        ]
    },

    luzia: {
        title: "Luzia e Fósseis Humanos Antigos",
        baseDescription: "Conjunto de restos humanos antigos da região de Lagoa Santa, Minas Gerais, frequentemente associado ao debate sobre as primeiras populações das Américas.",
        keyFacts: [
            "💀 Restos cranianos de indivíduos datados para o Holoceno inicial.",
            "📍 Região cárstica de Lagoa Santa, MG.",
            "🏛️ Contexto de importantes coleções museológicas brasileiras."
        ],
        significance: "Referência em discussões sobre diversidade biológica inicial e rotas de povoamento do continente.",
        controversies: "Interpretações morfológicas, calibração de datações e relações com populações indígenas atuais.",
        period: "Holoceno inicial",
        region: "Sudeste",
        type: "fóssil humano / povoamento",
        keywords: [
            "luzia",
            "fóssil humano antigo",
            "lagoa santa",
            "povoamento das américas"
        ],
        sources: [
            { name: "Museu Nacional", url: "https://www.museunacional.ufrj.br" }
        ]
    },

    arte_rupestre: {
        title: "Arte Rupestre no Brasil",
        baseDescription: "Registro gráfico em rochas, abrigos e cavernas, com grande diversidade de estilos, técnicas e cronologias.",
        keyFacts: [
            "🎨 Técnicas: pintura, gravura, picoteamento.",
            "📅 Períodos variados, da ocupação inicial a tempos históricos.",
            "📍 Ocorrências importantes no Nordeste, Sudeste, Amazônia e Centro-Oeste.",
            "🎯 Temas: fauna, figuras humanas, cenas de caça, motivos abstratos."
        ],
        significance: "Fonte fundamental para estudos de simbolismo, cosmologias e territorialidade de grupos pré-históricos.",
        preservation: "Vulnerável à ação humana, ao intemperismo e a alterações ambientais.",
        period: "Vários períodos",
        region: "Diversas regiões",
        type: "manifestação artística",
        keywords: [
            "arte rupestre",
            "pintura rupestre",
            "gravura rupestre",
            "painéis rupestres"
        ],
        sources: [
            { name: "IPHAN", url: "http://portal.iphan.gov.br/" }
        ]
    },

    ceramica_marajoara: {
        title: "Cerâmica Marajoara",
        baseDescription: "Tradição cerâmica elaborada da ilha de Marajó, marcada por decoração complexa e associação a contextos domésticos e funerários.",
        keyFacts: [
            "🏺 Produzida na ilha de Marajó, região do baixo Amazonas.",
            "📅 Desenvolvida aproximadamente no 1º milênio d.C.",
            "🎨 Motivos geométricos, antropomorfos e zoomorfos em alto e baixo‑relevo.",
            "⚱️ Urnas funerárias e vasos com forte carga simbólica."
        ],
        significance: "Indica sociedades amazônicas com alta complexidade social e organização política sofisticada.",
        currentResearch: "Estudos de tecnologia cerâmica, iconografia e interações regionais.",
        period: "1º milênio d.C.",
        region: "Amazônia",
        type: "cultura arqueológica / cerâmica",
        keywords: [
            "cerâmica marajoara",
            "marajó",
            "cultura marajoara",
            "urna marajoara"
        ],
        sources: [
            { name: "MPEG", url: "https://www.museu-goeldi.br" },
            { name: "USP", url: "https://www.usp.br" }
        ]
    }
};
 // ===== FUNÇÃO DE EXPANSÃO DE CONSULTA (APRIMORADA) ===== //
function expandQuery(query) {
    if (!query) return '';

    // Reusa a mesma lógica de normalização usada no dicionário de sinônimos
    const original = query.trim();
    const normalized = normalizeForSynonyms(original);
    
    const words = normalized.split(/\s+/).filter(Boolean);
    const expanded = new Set(words);

    // Adiciona sinônimos de cada palavra
    words.forEach(word => {
        if (synonymDictionary[word]) {
            synonymDictionary[word].forEach(syn => {
                // adiciona a forma normalizada, mas mantém também a forma original na consulta
                expanded.add(normalizeForSynonyms(syn));
            });
        }
    });

    // Monta uma string única com todos os termos expandidos (sem duplicatas)
    return Array.from(expanded).join(' ');
}


// ===== FUNÇÃO DE CORRESPONDÊNCIA DE CONSULTA (APRIMORADA) ===== //
function queryMatches(field, query) {
    if (!field || !query) return false;

    // Normaliza ambos para comparação mais robusta (sem acento/maiúsculas)
    const fieldNorm = normalizeForSynonyms(field);
    const queryNorm = normalizeForSynonyms(query);

    // 1) Tenta casar a consulta inteira
    if (fieldNorm.includes(queryNorm)) return true;

    // 2) Tenta casar palavra a palavra
    const tokens = queryNorm.split(/\s+/).filter(t => t.length > 1);
    for (const token of tokens) {
        if (fieldNorm.includes(token)) return true;
    }

    // 3) Procura sinônimos para cada token
    for (const token of tokens) {
        // Se o token for chave do dicionário
        if (synonymDictionary[token]) {
            for (const syn of synonymDictionary[token]) {
                const synNorm = normalizeForSynonyms(syn);
                if (fieldNorm.includes(synNorm)) return true;
            }
        }

        // Também verifica se o token aparece como sinônimo de alguma chave
        for (const [key, syns] of Object.entries(synonymDictionary)) {
            const keyNorm = normalizeForSynonyms(key);
            if (token === keyNorm && fieldNorm.includes(keyNorm)) {
                return true;
            }
            for (const syn of syns) {
                const synNorm = normalizeForSynonyms(syn);
                if (token === synNorm && fieldNorm.includes(synNorm)) {
                    return true;
                }
            }
        }
    }

    return false;
}
// ===== VARIÁVEIS GLOBAIS ===== //
let map;
let modalMap;
let selectionMarker = null;
let modalSelectionMarker = null;
let isSelectingLocation = false;
let userAddedSites = JSON.parse(localStorage.getItem('userAddedSites')) || [];
let currentMarkers = [];
let imageSourceType = 'file';
let currentSearchResults = [];
let currentPage = 1;
const RESULTS_PER_PAGE = 10;
const searchHistory = JSON.parse(localStorage.getItem('archaeologySearchHistory')) || [];
const responseSystem = new HybridResponseSystem();
window.responseSystem = responseSystem;

       // ===== SISTEMA DE NOTIFICAÇÕES (APRIMORADO) ===== //

// Controla timers para não “bugar” animações quando várias notificações são disparadas
let _notificationShowTimeout = null;
let _notificationHideTimeout = null;

function showNotification(message, type = 'info', duration = 5000) {
    const notification = document.getElementById('notification');
    if (!notification) return;

    // Limpa timers anteriores se ainda estiverem ativos
    if (_notificationShowTimeout) clearTimeout(_notificationShowTimeout);
    if (_notificationHideTimeout) clearTimeout(_notificationHideTimeout);

    // Define ícone por tipo (opcional)
    const icons = {
        success: '✅',
        error: '❌',
        warning: '⚠️',
        info: 'ℹ️'
    };
    const icon = icons[type] || icons.info;

    // Conteúdo e classe
    notification.innerHTML = `<span class="notification-icon">${icon}</span><span class="notification-text">${message}</span>`;
    notification.className = `notification ${type}`;
    notification.style.display = 'block';

    // Força reflow rápido para a animação funcionar de forma consistente
    // eslint-disable-next-line no-unused-expressions
    notification.offsetHeight;

    _notificationShowTimeout = setTimeout(() => {
        notification.classList.add('show');
    }, 50);

    _notificationHideTimeout = setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => {
            notification.style.display = 'none';
        }, 300); // tempo para a transição CSS terminar
    }, duration);
}


// ===== SISTEMA DE PESQUISA INTELIGENTE (APRIMORADO) ===== //

const intelligentSummaryGenerator = {
    generateSummary(query, results) {
        if (!results || results.length === 0) {
            return `
                <p>
                    Nenhum resultado encontrado para <strong>"${query}"</strong>.
                    Tente combinar tema, período (por exemplo, Holoceno, Colonial) e região
                    (Nordeste, Amazônia) para refinar a busca.
                </p>
            `;
        }

        const mainTopic = this.identifyMainTopic(query);
        const analysis = this.analyzeResults(results);
        return this.createSummary(mainTopic, analysis, query);
    },

    identifyMainTopic(query) {
        const q = String(query || '').toLowerCase();

        const topics = {
            sambaqui: 'sambaquis',
            'cerâmica': 'cerâmica arqueológica',
            ceramica: 'cerâmica arqueológica',
            'lítico': 'artefatos líticos',
            litico: 'artefatos líticos',
            rupestre: 'arte rupestre',
            museu: 'museus arqueológicos',
            'sítio': 'sítios arqueológicos',
            sitio: 'sítios arqueológicos',
            'escavação': 'escavações arqueológicas',
            escavacao: 'escavações arqueológicas',
            'indígena': 'ocupações indígenas',
            indigena: 'ocupações indígenas',
            colonial: 'período colonial',
            'pré-colonial': 'período pré-colonial',
            'pre-colonial': 'período pré-colonial',
            holoceno: 'período Holoceno',
            pleistoceno: 'período Pleistoceno'
        };

        for (const [key, value] of Object.entries(topics)) {
            if (q.includes(key)) return value;
        }

        return 'arqueologia';
    },

    analyzeResults(results) {
        const safeResults = Array.isArray(results) ? results : [];

        const analysis = {
            totalResults: safeResults.length,
            sites: [],
            periods: new Set(),
            regions: new Set(),
            types: new Set(),
            keySites: [],
            artifactsCount: 0
        };

        safeResults.forEach(result => {
            // Sítios com metadados completos
            if (result.isSite && result.siteData) {
                const site = result.siteData;

                analysis.sites.push(site);

                if (site.period) analysis.periods.add(site.period);
                if (site.region) analysis.regions.add(site.region);
                if (site.type) analysis.types.add(site.type);

                if (typeof site.artifacts === 'number') {
                    analysis.artifactsCount += site.artifacts;
                }

                const status = String(site.status || '');
                if (
                    (typeof site.artifacts === 'number' && site.artifacts > 500) ||
                    status.includes('Patrimônio') ||
                    status.includes('UNESCO')
                ) {
                    analysis.keySites.push(site);
                }
            } else {
                // Resultados temáticos também podem contribuir com períodos/tipos
                if (result.period) analysis.periods.add(result.period);
                if (result.type) analysis.types.add(result.type);
            }
        });

        return analysis;
    },

    createSummary(topic, analysis, query) {
        let summary = `
            <p>
                Baseado na sua pesquisa sobre <strong>"${query}"</strong>,
                foram encontrados <strong>${analysis.totalResults}</strong>
                resultado(s) relevantes.
        `;

        if (analysis.sites.length > 0) {
            summary += `
                Destes, <strong>${analysis.sites.length}</strong> são sítios arqueológicos documentados.
            `;

            if (analysis.artifactsCount > 0) {
                summary += `
                    Esses sítios reúnem aproximadamente
                    <strong>${analysis.artifactsCount}</strong> artefatos registrados.
                `;
            }

            if (analysis.periods.size > 0) {
                summary += `
                    Os períodos representados incluem:
                    <strong>${Array.from(analysis.periods).join(', ')}</strong>.
                `;
            }

            if (analysis.regions.size > 0) {
                summary += `
                    As regiões contempladas nos resultados abrangem:
                    <strong>${Array.from(analysis.regions).join(', ')}</strong>.
                `;
            }

            if (analysis.keySites.length > 0) {
                const names = analysis.keySites
                    .map(site => site.name)
                    .filter(Boolean);

                if (names.length > 0) {
                    summary += `
                        Entre os sítios mais significativos destacam-se:
                        <strong>${names.join(', ')}</strong>.
                    `;
                }
            }
        }

        // Informação específica pelo tema
        summary += this.addTopicSpecificInfo(topic, analysis);
        summary += `</p>`;

        // Pontos-chave
        if (
            analysis.keySites.length > 0 ||
            analysis.artifactsCount > 1000 ||
            analysis.periods.size > 1 ||
            (analysis.regions && analysis.regions.size > 1)
        ) {
            summary += `
                <div class="summary-key-points">
                    <h4>Pontos-chave:</h4>
                    <ul>
            `;

            if (analysis.keySites.length > 0) {
                const names = analysis.keySites
                    .slice(0, 3)
                    .map(site => site.name)
                    .filter(Boolean);

                if (names.length > 0) {
                    summary += `
                        <li><strong>Sítios importantes:</strong> ${names.join(', ')}</li>
                    `;
                }
            }

            if (analysis.artifactsCount > 1000) {
                const arredondado =
                    Math.floor(analysis.artifactsCount / 1000) * 1000;
                summary += `
                    <li>
                        <strong>Grande volume de artefatos:</strong>
                        Mais de ${arredondado} artefatos registrados.
                    </li>
                `;
            }

            if (analysis.periods.size > 1) {
                summary += `
                    <li>
                        <strong>Ampla cobertura temporal:</strong>
                        ${Array.from(analysis.periods).slice(0, 3).join(', ')}
                    </li>
                `;
            }

            if (analysis.regions && analysis.regions.size > 1) {
                summary += `
                    <li>
                        <strong>Distribuição regional ampla:</strong>
                        ${Array.from(analysis.regions).slice(0, 3).join(', ')}
                    </li>
                `;
            }

            summary += `
                    </ul>
                </div>
            `;
        }

        return summary;
    },

    addTopicSpecificInfo(topic, analysis) {
        switch (topic) {
            case 'sambaquis':
                return 'Sambaquis são sítios formados por acúmulos de conchas, restos de alimentação e materiais culturais, fundamentais para entender populações costeiras pré-históricas. ';
            case 'cerâmica arqueológica':
                return 'A cerâmica arqueológica revela tecnologias de produção, redes de troca e aspectos cronológicos das sociedades antigas. ';
            case 'arte rupestre':
                return 'A arte rupestre reúne pinturas e gravuras em rocha que expressam aspectos da vida cotidiana, das crenças e da visão de mundo de grupos antigos. ';
            case 'museus arqueológicos':
                return 'Museus arqueológicos preservam, pesquisam e comunicam o patrimônio cultural, atuando como espaços centrais de educação e salvaguarda. ';
            default:
                return 'Os resultados representam uma amostra significativa do patrimônio arqueológico documentado para esse tema. ';
        }
    },

    generateSources(results) {
        const sourceMap = new Map();

        // Fontes padrão
        [
            { name: 'ArchaeologyWorld', url: '#' },
            { name: 'IPHAN', url: 'http://portal.iphan.gov.br/' }
        ].forEach(src => {
            const key = `${src.name}|${src.url}`;
            sourceMap.set(key, src);
        });

        // Fontes vindas dos resultados
        (results || []).forEach(result => {
            if (Array.isArray(result.sources)) {
                result.sources.forEach(src => {
                    if (!src || !src.name || !src.url) return;
                    const key = `${src.name}|${src.url}`;
                    if (!sourceMap.has(key)) {
                        sourceMap.set(key, src);
                    }
                });
            }
        });

        return Array.from(sourceMap.values());
    },

    generateTags(analysis) {
        const tags = new Set();

        analysis.periods.forEach(period => {
            if (period && period !== 'Vários períodos') {
                tags.add(period);
            }
        });

        analysis.types.forEach(type => {
            if (type) tags.add(type);
        });

        if (analysis.artifactsCount > 1000) {
            tags.add('Grande Acervo');
        }

        if (analysis.keySites.length > 0) {
            tags.add('Sítios Importantes');
        }

        if (analysis.regions && analysis.regions.size > 1) {
            tags.add('Diversas Regiões');
        }

        return Array.from(tags).slice(0, 8);
    }
};

// ===== EXIBIÇÃO DO RESUMO INTELIGENTE NO HTML ===== //

async function displayEnhancedIntelligentSummary(query, results) {
    const summaryBox = document.getElementById('intelligentSummary');
    const contentEl  = document.getElementById('summaryContent');
    const sourcesEl  = document.getElementById('summarySources');
    const tagsEl     = document.getElementById('summaryTags');

    if (!summaryBox || !contentEl) return;

    // Sem resultados: esconde o bloco
    if (!results || !results.length) {
        summaryBox.style.display = 'none';
        contentEl.innerHTML = '';
        if (sourcesEl) sourcesEl.innerHTML = '';
        if (tagsEl) tagsEl.innerHTML = '';
        return;
    }

    const safeQuery = String(query || '');

    // Texto principal do resumo
    const summaryHtml = intelligentSummaryGenerator.generateSummary(safeQuery, results);
    contentEl.innerHTML = summaryHtml;

    // Fontes
    if (typeof intelligentSummaryGenerator.generateSources === 'function' && sourcesEl) {
        const sources = intelligentSummaryGenerator.generateSources(results);
        sourcesEl.innerHTML = (sources || [])
            .map(src => `<a href="${src.url}" target="_blank" rel="noopener noreferrer">${src.name}</a>`)
            .join('');
    }

    // Tags (períodos, tipos, etc.)
    if (
        typeof intelligentSummaryGenerator.analyzeResults === 'function' &&
        typeof intelligentSummaryGenerator.generateTags === 'function' &&
        tagsEl
    ) {
        const analysis = intelligentSummaryGenerator.analyzeResults(results);
        const tags = intelligentSummaryGenerator.generateTags(analysis) || [];
        tagsEl.innerHTML = tags
            .map(tag => `<span class="summary-tag">${tag}</span>`)
            .join('');
    }

    summaryBox.style.display = 'block';
}
     // ===== SISTEMA DE PESQUISA APRIMORADO (VERSÃO AVANÇADA) ===== //

// Base de conhecimento arqueológica expandida
const archaeologicalAPI = {
    // ===== BUSCA PRINCIPAL ===== //
    search: async function(query, filters = {}) {
    const q = String(query || '').trim();
    if (!q) return this.generateNoResultsHelp(query);

        return new Promise(resolve => {
            // Delay pequeno para simular “pensamento” e permitir UI mostrar loading
            setTimeout(() => {
                const results = this.generateEnhancedResults(q, filters);
                resolve(results);
            }, 400);
        });
    },

    // ===== GERAÇÃO DE RESULTADOS ===== //
    generateEnhancedResults: function (query, filters = {}) {
        const normalizedQuery = normalizeForSynonyms(query);
        const resultsSet = new Set(); // evitar duplicatas via JSON

        // 1. Sítios (base principal)
        const siteResults = this.searchAllSites(normalizedQuery, filters);
        siteResults.forEach(r => resultsSet.add(JSON.stringify(r)));

        // 2. Temas e conceitos
        const themeResults = this.searchThemes(normalizedQuery, filters);
        themeResults.forEach(r => resultsSet.add(JSON.stringify(r)));

        // 3. Períodos históricos
        const periodResults = this.searchPeriods(normalizedQuery);
        periodResults.forEach(r => resultsSet.add(JSON.stringify(r)));

        // 4. Técnicas e metodologias
        const techniqueResults = this.searchTechniques(normalizedQuery);
        techniqueResults.forEach(r => resultsSet.add(JSON.stringify(r)));

        // 5. Culturas e civilizações
        const cultureResults = this.searchCultures(normalizedQuery);
        cultureResults.forEach(r => resultsSet.add(JSON.stringify(r)));

        // 6. Materiais e tipos de artefatos
        const materialResults = this.searchMaterials(normalizedQuery);
        materialResults.forEach(r => resultsSet.add(JSON.stringify(r)));

        // 7. Instituições e museus
        const institutionResults = this.searchInstitutions(normalizedQuery);
        institutionResults.forEach(r => resultsSet.add(JSON.stringify(r)));

        // 8. Eventos e descobertas
        const eventResults = this.searchEvents(normalizedQuery);
        eventResults.forEach(r => resultsSet.add(JSON.stringify(r)));

        const finalResults = Array.from(resultsSet).map(str => JSON.parse(str));

        finalResults.sort((a, b) => (b.relevance || 0) - (a.relevance || 0));

        return finalResults.length > 0
            ? finalResults
            : [this.generateNoResultsHelp(query)];
    },

    // ===== BUSCA EM SÍTIOS ===== //
    searchAllSites: function (query, filters) {
        const results = [];
        const allSites = [...(window.sites || sites || []), ...(userAddedSites || [])];


        allSites.forEach(site => {
            if (this.siteMatchesEnhancedQuery(site, query, filters)) {
                const relevance = this.calculateEnhancedSiteRelevance(site, query);
                if (relevance > 0.1) {
                    results.push(this.convertSiteToEnhancedResult(site, query, relevance));
                }
            }
        });

        return results;
    },

    // ===== TEMAS / CONCEITOS ===== //
    searchThemes: function (query, filters) {
        const results = [];
        const themes = this.getEnhancedThemesForQuery(query);

        themes.forEach(themeKey => {
            const themeData = this.enhancedThemeDatabase[themeKey];
            if (!themeData) return;

            const relevance = this.calculateThemeRelevance(themeData, query);
            results.push({
                title: themeData.title,
                description: this.generateEnhancedDescription(themeData, query),
                sources: themeData.sources || [],
                links: themeData.links || [],
                type: themeData.type || 'tema',
                relevance,
                artifacts: 0,
                period: themeData.period || 'Vários períodos',
                isSite: false,
                isTheme: true,
                themeData
            });
        });

        return results;
    },

    // ===== PERÍODOS HISTÓRICOS ===== //
    searchPeriods: function (query) {
        const q = normalizeForSynonyms(query);
        const results = [];
        const periods = {
            'Paleoíndio': { start: -12000, end: -8000, description: 'Período dos primeiros habitantes das Américas' },
            'Arcaico': { start: -8000, end: -1000, description: 'Período de adaptação aos ambientes locais' },
            'Formativo': { start: -1000, end: 1500, description: 'Desenvolvimento da agricultura e sociedades complexas' },
            'Colonial': { start: 1500, end: 1822, description: 'Período de colonização europeia' },
            'Imperial': { start: 1822, end: 1889, description: 'Período do Brasil Império' }
        };

        Object.entries(periods).forEach(([period, data]) => {
            const pNorm = normalizeForSynonyms(period);
            if (pNorm.includes(q) || q.includes(pNorm)) {
                const startAbs = Math.abs(data.start);
                const endAbs = Math.abs(data.end);
                const startLabel = data.start < 0 ? 'a.C.' : 'd.C.';
                const endLabel = data.end < 0 ? 'a.C.' : 'd.C.';

                results.push({
                    title: `Período ${period}`,
                    description: `${data.description}. Este período abrange aproximadamente de ${startAbs} ${startLabel} a ${endAbs} ${endLabel}.`,
                    sources: [
                        { name: 'IPHAN', url: 'http://portal.iphan.gov.br/' },
                        { name: 'Museu Nacional', url: 'https://www.museunacional.ufrj.br' }
                    ],
                    links: [
                        { name: 'Saiba mais sobre este período', url: '#' }
                    ],
                    type: 'period',
                    relevance: 0.8,
                    artifacts: 0,
                    period,
                    isSite: false,
                    isTheme: true
                });
            }
        });

        return results;
    },

    // ===== TÉCNICAS ARQUEOLÓGICAS ===== //
    searchTechniques: function (query) {
        const q = normalizeForSynonyms(query);
        const techniques = {
            'escavação': 'Técnica de remoção sistemática de sedimentos para revelar estruturas e artefatos.',
            'estratigrafia': 'Estudo das camadas do solo para determinar a sequência temporal.',
            'datação': 'Métodos como carbono-14, termoluminescência e arqueomagnetismo.',
            'prospecção': 'Localização de sítios através de métodos não invasivos.',
            'cerâmica': 'Análise de vasos, urnas e fragmentos cerâmicos.',
            'lítico': 'Estudo de ferramentas e artefatos de pedra.',
            'zooarqueologia': 'Análise de restos animais em contextos arqueológicos.',
            'paleobotânica': 'Estudo de restos vegetais e sementes.'
        };

        const results = [];
        Object.entries(techniques).forEach(([tech, desc]) => {
            const tNorm = normalizeForSynonyms(tech);
            if (tNorm.includes(q) || q.includes(tNorm)) {
                results.push({
                    title: `Técnica: ${tech.charAt(0).toUpperCase() + tech.slice(1)}`,
                    description: desc,
                    sources: [
                        { name: 'Sociedade de Arqueologia Brasileira', url: 'https://www.sabnet.com.br' }
                    ],
                    links: [
                        { name: 'Mais sobre esta técnica', url: '#' }
                    ],
                    type: 'technique',
                    relevance: 0.7,
                    artifacts: 0,
                    period: 'Metodologia',
                    isSite: false,
                    isTheme: true
                });
            }
        });

        return results;
    },

    // ===== CULTURAS E CIVILIZAÇÕES ===== //
    searchCultures: function (query) {
        const q = normalizeForSynonyms(query);
        const cultures = {
            'tupi-guarani': 'Povos indígenas do litoral brasileiro com cerâmica característica.',
            'marajoara': 'Cultura complexa da ilha de Marajó conhecida por sua cerâmica elaborada.',
            'sambaquieira': 'Grupos construtores de sambaquis no litoral brasileiro.',
            'inca': 'Civilização andina com império extenso e arquitetura monumental.',
            'maia': 'Civilização mesoamericana com escrita e calendário complexos.',
            'asteca': 'Império do México central com arquitetura e arte sofisticadas.'
        };

        const results = [];
        Object.entries(cultures).forEach(([culture, desc]) => {
            const cNorm = normalizeForSynonyms(culture);
            if (cNorm.includes(q) || q.includes(cNorm)) {
                results.push({
                    title: `Cultura ${culture.charAt(0).toUpperCase() + culture.slice(1)}`,
                    description: desc,
                    sources: [
                        { name: 'IPHAN', url: 'http://portal.iphan.gov.br/' },
                        { name: 'Museu Nacional', url: 'https://www.museunacional.ufrj.br' }
                    ],
                    links: [
                        { name: 'Conhecer mais sobre esta cultura', url: '#' }
                    ],
                    type: 'culture',
                    relevance: 0.75,
                    artifacts: 0,
                    period: 'Vários períodos',
                    isSite: false,
                    isTheme: true
                });
            }
        });

        return results;
    },

    // ===== MATERIAIS / ARTEFATOS ===== //
    searchMaterials: function (query) {
        const q = normalizeForSynonyms(query);
        const materials = {
            'cerâmica': 'Vasos, urnas funerárias e objetos de barro cozido.',
            'lítico': 'Ferramentas de pedra lascada e polida.',
            'osso': 'Ferramentas e adornos feitos de ossos animais.',
            'concha': 'Objetos feitos de conchas marinhas.',
            'metal': 'Objetos de cobre, bronze, ouro e outros metais.',
            'textil': 'Tecidos e cordas preservados em condições especiais.'
        };

        const results = [];
        Object.entries(materials).forEach(([material, desc]) => {
            const mNorm = normalizeForSynonyms(material);
            if (mNorm.includes(q) || q.includes(mNorm)) {
                results.push({
                    title: `Artefatos de ${material}`,
                    description: desc,
                    sources: [
                        { name: 'Museu de Arqueologia e Etnologia USP', url: 'https://www.mae.usp.br' }
                    ],
                    links: [
                        { name: 'Ver artefatos deste material', url: '#' }
                    ],
                    type: 'material',
                    relevance: 0.6,
                    artifacts: 0,
                    period: 'Vários períodos',
                    isSite: false,
                    isTheme: true
                });
            }
        });

        return results;
    },

    // ===== INSTITUIÇÕES ===== //
    searchInstitutions: function (query) {
        const q = normalizeForSynonyms(query);
        const institutions = {
            'iphan': 'Instituto do Patrimônio Histórico e Artístico Nacional.',
            'usp': 'Universidade de São Paulo – Museu de Arqueologia e Etnologia.',
            'museu nacional': 'Museu Nacional da Universidade Federal do Rio de Janeiro.',
            'unasp': 'Centro Universitário Adventista de São Paulo – Museu de Arqueologia Bíblica.',
            'sab': 'Sociedade de Arqueologia Brasileira.'
        };

        const results = [];
        Object.entries(institutions).forEach(([inst, desc]) => {
            const iNorm = normalizeForSynonyms(inst);
            if (iNorm.includes(q) || q.includes(iNorm)) {
                results.push({
                    title: inst.charAt(0).toUpperCase() + inst.slice(1),
                    description: desc,
                    sources: [
                        { name: 'Site Oficial', url: '#' }
                    ],
                    links: [
                        { name: 'Visitar site', url: '#' }
                    ],
                    type: 'institution',
                    relevance: 0.7,
                    artifacts: 0,
                    period: 'Contemporâneo',
                    isSite: false,
                    isTheme: true
                });
            }
        });

        return results;
    },

    // ===== EVENTOS / DESCOBERTAS ===== //
    searchEvents: function (query) {
        const q = normalizeForSynonyms(query);
        const events = {
            'descoberta da luzia': 'Década de 1990 – Descoberta de fósseis humanos antigos em Minas Gerais.',
            'incêndio museu nacional': '2018 – Incêndio que destruiu grande parte do acervo do Museu Nacional.',
            'serra da capivara': 'Décadas de pesquisas que revolucionaram teorias sobre povoamento das Américas.',
            'pedra furada': 'Sítio com evidências de ocupação humana antiga no Piauí.'
        };

        const results = [];
        Object.entries(events).forEach(([event, desc]) => {
            const eNorm = normalizeForSynonyms(event);
            if (eNorm.includes(q) || q.includes(eNorm)) {
                results.push({
                    title: `Evento: ${event.charAt(0).toUpperCase() + event.slice(1)}`,
                    description: desc,
                    sources: [
                        { name: 'IPHAN', url: 'http://portal.iphan.gov.br/' },
                        { name: 'Museu Nacional', url: 'https://www.museunacional.ufrj.br' }
                    ],
                    links: [
                        { name: 'Ler mais sobre este evento', url: '#' }
                    ],
                    type: 'event',
                    relevance: 0.8,
                    artifacts: 0,
                    period: 'Contemporâneo',
                    isSite: false,
                    isTheme: true
                });
            }
        });

        return results;
    },

    // ===== MATCH EM SÍTIOS + FILTROS ===== //
    siteMatchesEnhancedQuery: function (site, query, filters) {
        const searchFields = [
            site.name,
            site.type,
            site.period,
            site.status,
            site.description || '',
            site.site || '',
            site.culture || '',
            site.biome || '',
            site.institution || ''
        ];

        const matchesQuery = searchFields.some(field => {
            if (!field) return false;

            if (queryMatches(field, query)) return true;

            const tokens = query.split(/\s+/).filter(w => w.length > 2);
            if (tokens.length > 1) {
                return tokens.some(word => queryMatches(field, word));
            }

            return false;
        });

        if (!matchesQuery) return false;
        return this.applyFiltersToSite(site, filters);
    },

    applyFiltersToSite: function (site, filters) {
        if (filters.type && filters.type !== 'all') {
            const typeMap = {
                sites: [
                    'Sítio em Escavação',
                    'Sítio Documentado',
                    'Sítio de Ocupação Indígena',
                    'Sítio Funerário',
                    'Aldeia',
                    'Acampamento',
                    'Sambaqui',
                    'Cemitério'
                ],
                artifacts: ['Artefato Registrado'],
                museums: ['Museus Arqueológicos'],
                structures: [
                    'Estrutura Arqueológica',
                    'Abrigo sob Rocha',
                    'Abrigo com Arte Rupestre',
                    'Sítio com Arte Rupestre'
                ],
                areas: ['Área Protegida']
            };

            const allowed = typeMap[filters.type] || [];
            if (!allowed.includes(site.type)) return false;
        }

        if (filters.period && filters.period !== 'all' && site.period) {
            if (!site.period.toLowerCase().includes(filters.period.toLowerCase())) {
                return false;
            }
        }

        if (filters.region && filters.region !== 'all') {
            const coords = site.coords || [];
            // Lógica simplificada: se marcar “Internacional”, exclui coords típicas do Brasil
            if (filters.region === 'Internacional') {
                if (coords.length === 2 && coords[0] > -35) {
                    return false;
                }
            }
        }

        return true;
    },

    // ===== RELEVÂNCIA DE SÍTIOS ===== //
    calculateEnhancedSiteRelevance: function (site, query) {
        const q = normalizeForSynonyms(query);
        let relevance = 0.3;

        const fieldWeights = {
            name: 0.4,
            type: 0.2,
            period: 0.15,
            description: 0.1,
            culture: 0.1,
            status: 0.05
        };

        Object.entries(fieldWeights).forEach(([field, weight]) => {
            if (site[field]) {
                const fNorm = normalizeForSynonyms(String(site[field]));
                if (fNorm.includes(q)) relevance += weight;
            }
        });

        if (site.name && normalizeForSynonyms(site.name) === q) {
            relevance += 0.2;
        }

        if (typeof site.artifacts === 'number' && site.artifacts > 500) {
            relevance += 0.1;
        }

        if (site.status && site.status.includes('Patrimônio Mundial')) {
            relevance += 0.15;
        }

        return Math.min(relevance, 1.0);
    },

    // ===== TEMAS / MAPEAMENTO DE PALAVRAS-CHAVE ===== //
    getEnhancedThemesForQuery: function (query) {
        const q = normalizeForSynonyms(query);
        const themes = new Set();

        const keywordMap = {
            'serra da capivara': 'serra_capivara',
            'capivara': 'serra_capivara',
            'luzia': 'luzia',
            'fossil': 'luzia',
            'cranio': 'luzia',
            'sambaqui': 'sambaqui',
            'concha': 'sambaqui',
            'arte rupestre': 'arte_rupestre',
            'pintura rupestre': 'arte_rupestre',
            'gravura rupestre': 'arte_rupestre',
            'ceramica marajoara': 'ceramica_marajoara',
            'marajoara': 'ceramica_marajoara',
            'marajo': 'ceramica_marajoara',
            'arqueologia': 'arqueologia_geral',
            'patrimonio': 'patrimonio_cultural'
        };

        Object.entries(keywordMap).forEach(([keyword, theme]) => {
            const kNorm = normalizeForSynonyms(keyword);
            if (q.includes(kNorm) || kNorm.includes(q)) {
                themes.add(theme);
            }
        });

        const words = q.split(/\s+/).filter(w => w.length > 2);
        words.forEach(word => {
            Object.entries(keywordMap).forEach(([keyword, theme]) => {
                const kNorm = normalizeForSynonyms(keyword);
                if (kNorm.includes(word)) themes.add(theme);
            });
        });

        return themes.size > 0 ? Array.from(themes) : ['arqueologia_geral'];
    },

    // ===== BASE DE TEMAS ===== //
    enhancedThemeDatabase: enhancedThemeDatabase,

    // ===== DESCRIÇÃO DE TEMAS ===== //
    generateEnhancedDescription: function (themeData, query) {
        const q = query.toLowerCase();
        let description = themeData.baseDescription || '';

        if (q.includes('importante') || q.includes('signific')) {
            description += ' Este tema é considerado de grande importância para a compreensão da história humana.';
        }

        if (q.includes('como') || q.includes('técnica') || q.includes('tecnica')) {
            description += ' As pesquisas frequentemente utilizam métodos como escavação estratigráfica, datação radiocarbônica e análises laboratoriais especializadas.';
        }

        if (q.includes('onde') || q.includes('local')) {
            description += ' A localização exata e o contexto regional variam de acordo com o período e a cultura estudados.';
        }

        return description;
    },

    // ===== RELEVÂNCIA DE TEMAS ===== //
    calculateThemeRelevance: function (themeData, query) {
        const q = normalizeForSynonyms(query);
        let relevance = 0.6;

        (themeData.keywords || []).forEach(keyword => {
            const kNorm = normalizeForSynonyms(keyword);
            if (q === kNorm) relevance += 0.3;
            else if (q.includes(kNorm)) relevance += 0.15;
        });

        return Math.min(relevance, 1.0);
    },

    // ===== CONVERSÃO DE SÍTIO PARA RESULTADO ===== //
    convertSiteToEnhancedResult: function (site, query, relevance) {
        const baseDesc = site.description ||
            `${site.name} é um ${site.type ? site.type.toLowerCase() : 'sítio arqueológico'} do período ${site.period || 'indeterminado'}. ${site.status || ''}`;

        return {
            title: site.name,
            description: this.highlightQuery(baseDesc, query),
            sources: [
                { name: 'ArchaeologyWorld', url: '#' },
                { name: 'IPHAN', url: 'http://portal.iphan.gov.br/' }
            ],
            links: [
                { name: 'Ver no mapa', url: '#', action: () => this.focusOnSite(site) },
                { name: 'Mais informações', url: '#' }
            ],
            type: this.getResultType(site.type),
            relevance,
            artifacts: site.artifacts || 0,
            period: site.period || '',
            isSite: true,
            isTheme: false,
            siteData: site
        };
    },

    // ===== QUANDO NÃO HÁ RESULTADOS ===== //
    generateNoResultsHelp: function (query) {
        return {
            title: 'Nenhum resultado encontrado',
            description: `Não foram encontrados resultados para "${query}". Tente combinar tema (por exemplo, sambaqui, arte rupestre), período (Holoceno, Colonial) e região (Nordeste, Amazônia).`,
            sources: [],
            links: [
                { name: 'Serra da Capivara', url: '#', action: () => fillSearch('Serra da Capivara') },
                { name: 'Sambaquis', url: '#', action: () => fillSearch('Sambaqui') },
                { name: 'Arte Rupestre', url: '#', action: () => fillSearch('Arte Rupestre') }
            ],
            type: 'help',
            relevance: 1.0,
            artifacts: 0,
            period: '',
            isSite: false,
            isHelp: true
        };
    },

    // ===== AUXILIARES ===== //
    highlightQuery: function (text, query) {
        if (!query) return text;
        const safe = query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        const regex = new RegExp(`(${safe})`, 'gi');
        return text.replace(regex, '<span class="result-highlight">$1</span>');
    },

    getResultType: function (siteType) {
        const typeMap = {
            'Sítio em Escavação': 'sites',
            'Sítio Documentado': 'sites',
            'Sítio de Ocupação Indígena': 'sites',
            'Sítio Funerário': 'sites',
            'Aldeia': 'sites',
            'Acampamento': 'sites',
            'Sambaqui': 'sites',
            'Cemitério': 'sites',
            'Artefato Registrado': 'artifacts',
            'Museus Arqueológicos': 'museums',
            'Estrutura Arqueológica': 'structures',
            'Abrigo sob Rocha': 'structures',
            'Abrigo com Arte Rupestre': 'structures',
            'Sítio com Arte Rupestre': 'structures',
            'Área Protegida': 'areas'
        };
        return typeMap[siteType] || 'sites';
    },

    focusOnSite: function (site) {
        if (map && site.coords && Array.isArray(site.coords) && site.coords.length === 2) {
            map.setView(site.coords, 12);
            (currentMarkers || []).forEach(marker => {
                const markerLatLng = marker.getLatLng();
                if (markerLatLng.lat === site.coords[0] && markerLatLng.lng === site.coords[1]) {
                    marker.openPopup();
                }
            });
            const mapEl = document.getElementById('map');
            if (mapEl) mapEl.scrollIntoView({ behavior: 'smooth' });
        }
    }
};
// ===== SISTEMA DE SUGESTÕES INTELIGENTES (APRIMORADO) ===== //

function generateEnhancedSuggestions(query) {
    const raw = (query || '').trim();
    if (!raw) return [];

    const normalizedQuery = normalizeForSynonyms(raw);
    const suggestions = new Map(); // chave = texto, valor = score

    function addSuggestion(text, baseScore) {
        if (!text) return;
        const key = text.trim();
        if (!key) return;
        const current = suggestions.get(key) || 0;
        suggestions.set(key, Math.max(current, baseScore));
    }

    // 1. Nomes de sites (score alto)
    const allSites = [...(window.sites || []), ...(userAddedSites || [])];
    allSites.forEach(site => {
        if (!site || !site.name) return;
        const nameNorm = normalizeForSynonyms(site.name);
        if (nameNorm.includes(normalizedQuery)) {
            addSuggestion(site.name, 1.0);
        }
    });

    // 2. Temas e conceitos (usa keywords da base de temas)
    Object.keys(archaeologicalAPI.enhancedThemeDatabase || {}).forEach(themeKey => {
        const themeData = archaeologicalAPI.enhancedThemeDatabase[themeKey];
        if (!themeData) return;

        (themeData.keywords || []).forEach(keyword => {
            const kNorm = normalizeForSynonyms(keyword);
            if (kNorm.includes(normalizedQuery)) {
                addSuggestion(keyword, 0.9);
            }
        });

        const titleNorm = normalizeForSynonyms(themeData.title || '');
        if (titleNorm.includes(normalizedQuery)) {
            addSuggestion(themeData.title, 0.95);
        }
    });

    // 3. Tipos de sítios
    const siteTypes = [
        'Sítio em Escavação',
        'Sítio Documentado',
        'Área Protegida',
        'Artefato Registrado',
        'Estrutura Arqueológica',
        'Museus Arqueológicos',
        'Sambaqui',
        'Abrigo sob Rocha',
        'Oficina Lítica',
        'Aldeia'
    ];
    siteTypes.forEach(type => {
        const tNorm = normalizeForSynonyms(type.toLowerCase());
        if (tNorm.includes(normalizedQuery)) {
            addSuggestion(type, 0.7);
        }
    });

    // 4. Períodos históricos
    const periods = [
        'Paleoíndio',
        'Arcaico',
        'Formativo',
        'Pré-colonial',
        'Colonial',
        'Holoceno',
        'Pleistoceno'
    ];
    periods.forEach(period => {
        const pNorm = normalizeForSynonyms(period.toLowerCase());
        if (pNorm.includes(normalizedQuery)) {
            addSuggestion(period, 0.65);
        }
    });

    // 5. Técnicas e metodologias
    const techniques = ['Escavação', 'Estratigrafia', 'Datação', 'Prospecção', 'Cerâmica', 'Lítico'];
    techniques.forEach(tech => {
        const tNorm = normalizeForSynonyms(tech.toLowerCase());
        if (tNorm.includes(normalizedQuery)) {
            addSuggestion(tech, 0.6);
        }
    });

    // 6. Pequeno bônus se sugestão começar exatamente pela string digitada
    const qLower = raw.toLowerCase();
    Array.from(suggestions.keys()).forEach(text => {
        if (text.toLowerCase().startsWith(qLower)) {
            suggestions.set(text, (suggestions.get(text) || 0) + 0.1);
        }
    });

    // Ordena por score e retorna top 10
    return Array
        .from(suggestions.entries())
        .sort((a, b) => b[1] - a[1])
        .slice(0, 10)
        .map(([text]) => text);
}


// ===== FUNÇÃO PRINCIPAL DE BUSCA ATUALIZADA (APRIMORADA) ===== //

async function performSearch(query) {
    const raw = (query || '').trim();
    if (!raw) return;

    showLoading();

    try {
        const filters = {
            type: document.getElementById('searchType').value,
            period: document.getElementById('searchPeriod').value,
            region: document.getElementById('searchRegion').value
        };

        // Opcional: expandir com sinônimos para a busca interna,
        // mas manter a query original para exibir ao usuário.
        const expandedQuery = typeof expandQuery === 'function'
         ? expandQuery(raw)
         : raw;

        const results = await archaeologicalAPI.search(expandedQuery, filters);

        currentSearchResults = results;
        currentPage = 1;

        // Atualiza resumo inteligente com a query original do usuário
        await displayEnhancedIntelligentSummary(raw, results);

        displayEnhancedResults(results, raw);
        saveToSearchHistory(raw, results.length);

        // Atualiza RL (por exemplo, pode aplicar decaimento de interações antigas)
        if (responseSystem && responseSystem.rlSystem && typeof responseSystem.rlSystem.decayOldInteractions === 'function') {
            responseSystem.rlSystem.decayOldInteractions();
        }

    } catch (error) {
        console.error('Erro na busca:', error);
        displayError();
    }
}
      // ===== SISTEMA DE SUGESTÕES INTELIGENTES (APRIMORADO) ===== //

function generateEnhancedSuggestions(query) {
    const raw = (query || '').trim();
    if (!raw) return [];

    const normalizedQuery = normalizeForSynonyms(raw);
    const suggestions = new Map(); // chave = texto, valor = score

    function addSuggestion(text, baseScore) {
        if (!text) return;
        const key = text.trim();
        if (!key) return;
        const current = suggestions.get(key) || 0;
        suggestions.set(key, Math.max(current, baseScore));
    }

    // 1. Nomes de sites (score alto)
    const allSites = [...(window.sites || []), ...(userAddedSites || [])];
    allSites.forEach(site => {
        if (!site || !site.name) return;
        const nameNorm = normalizeForSynonyms(site.name);
        if (nameNorm.includes(normalizedQuery)) {
            addSuggestion(site.name, 1.0);
        }
    });

    // 2. Temas e conceitos (usa keywords da base de temas)
    Object.keys(archaeologicalAPI.enhancedThemeDatabase || {}).forEach(themeKey => {
        const themeData = archaeologicalAPI.enhancedThemeDatabase[themeKey];
        if (!themeData) return;

        (themeData.keywords || []).forEach(keyword => {
            const kNorm = normalizeForSynonyms(keyword);
            if (kNorm.includes(normalizedQuery)) {
                addSuggestion(keyword, 0.9);
            }
        });

        const titleNorm = normalizeForSynonyms(themeData.title || '');
        if (titleNorm.includes(normalizedQuery)) {
            addSuggestion(themeData.title, 0.95);
        }
    });

    // 3. Tipos de sítios
    const siteTypes = [
        'Sítio em Escavação',
        'Sítio Documentado',
        'Área Protegida',
        'Artefato Registrado',
        'Estrutura Arqueológica',
        'Museus Arqueológicos',
        'Sambaqui',
        'Abrigo sob Rocha',
        'Oficina Lítica',
        'Aldeia'
    ];
    siteTypes.forEach(type => {
        const tNorm = normalizeForSynonyms(type.toLowerCase());
        if (tNorm.includes(normalizedQuery)) {
            addSuggestion(type, 0.7);
        }
    });

    // 4. Períodos históricos
    const periods = [
        'Paleoíndio',
        'Arcaico',
        'Formativo',
        'Pré-colonial',
        'Colonial',
        'Holoceno',
        'Pleistoceno'
    ];
    periods.forEach(period => {
        const pNorm = normalizeForSynonyms(period.toLowerCase());
        if (pNorm.includes(normalizedQuery)) {
            addSuggestion(period, 0.65);
        }
    });

    // 5. Técnicas e metodologias
    const techniques = ['Escavação', 'Estratigrafia', 'Datação', 'Prospecção', 'Cerâmica', 'Lítico'];
    techniques.forEach(tech => {
        const tNorm = normalizeForSynonyms(tech.toLowerCase());
        if (tNorm.includes(normalizedQuery)) {
            addSuggestion(tech, 0.6);
        }
    });

    // 6. Pequeno bônus se sugestão começar exatamente pela string digitada
    const qLower = raw.toLowerCase();
    Array.from(suggestions.keys()).forEach(text => {
        if (text.toLowerCase().startsWith(qLower)) {
            suggestions.set(text, (suggestions.get(text) || 0) + 0.1);
        }
    });

    // Ordena por score e retorna top 10
    return Array
        .from(suggestions.entries())
        .sort((a, b) => b[1] - a[1])
        .slice(0, 10)
        .map(([text]) => text);
}
    // ===== ATUALIZAÇÃO DA FUNÇÃO displayEnhancedResults (APRIMORADA) ===== //
function displayEnhancedResults(results, query) {
    const resultsContainer = document.getElementById('resultsContainer');
    const resultsCount     = document.getElementById('resultsCount');
    const searchStats      = document.getElementById('searchStats');

    const safeQuery = String(query || '');
    const escapedQuery = safeQuery.replace(/"/g, '&quot;');

    if (!Array.isArray(results)) results = [];

    // Sem resultados (ou só card de ajuda)
    if (results.length === 0 || (results.length === 1 && results[0].isHelp)) {
        if (resultsContainer) {
            resultsContainer.innerHTML = `
                <div class="no-results">
                    <i class="fas fa-search"></i>
                    <h3>Nenhum resultado encontrado para "${escapedQuery}"</h3>
                    <p>Tente usar termos diferentes ou mais específicos. Você pode pesquisar por:</p>
                    <div class="search-tips">
                        <strong>Dicas de pesquisa:</strong>
                        <ul>
                            <li>Nomes de sítios específicos (ex: Serra da Capivara)</li>
                            <li>Tipos de sítios (ex: Sambaqui, Abrigo sob Rocha)</li>
                            <li>Períodos históricos (ex: Paleoíndio, Colonial)</li>
                            <li>Técnicas arqueológicas (ex: Escavação, Datação)</li>
                            <li>Materiais (ex: Cerâmica, Lítico)</li>
                        </ul>
                    </div>
                </div>
            `;
        }
        if (resultsCount) {
            resultsCount.textContent = '0 resultados encontrados';
        }
        if (searchStats) {
            searchStats.textContent = '';
        }
        return;
    }

    // Aplicar aprendizado de reforço se disponível
    let enhancedResults = results;
    if (
        window.responseSystem &&
        responseSystem.rlSystem &&
        typeof responseSystem.rlSystem.adjustRelevance === 'function'
    ) {
        enhancedResults = responseSystem.rlSystem.adjustRelevance(safeQuery, results);
    }

    // Remover card de ajuda se houver outros resultados
    const filteredResults = enhancedResults.filter(r => !r.isHelp);

    // Estatísticas
    const siteCount  = filteredResults.filter(r => r.isSite).length;
    const themeCount = filteredResults.filter(r => r.isTheme).length;
    const otherCount = Math.max(filteredResults.length - siteCount - themeCount, 0);

    if (searchStats) {
        searchStats.innerHTML = `
            <div class="search-analytics">
                <div class="analytics-item">
                    ${filteredResults.length} resultado${filteredResults.length !== 1 ? 's' : ''} encontrado${filteredResults.length !== 1 ? 's' : ''}
                    <span style="color: #28a745; font-size: 0.8em; margin-left: 10px;">
                        📊 Sistema inteligente ativo
                    </span>
                </div>
                <div class="analytics-breakdown">
                    ${siteCount} sítios • ${themeCount} temas • ${otherCount} outros
                </div>
            </div>
        `;
    }

    currentSearchResults = filteredResults;
    if (typeof sortResults === 'function') {
        sortResults();
    }
    displayPaginatedResults();

    if (resultsCount) {
        resultsCount.textContent =
            `${filteredResults.length} resultado${filteredResults.length !== 1 ? 's' : ''} para "${safeQuery}"`;
    }
}


// ===== ATUALIZAÇÃO DA FUNÇÃO displayPaginatedResults (APRIMORADA) ===== //
function displayPaginatedResults() {
    const resultsContainer = document.getElementById('resultsContainer');
    const pagination       = document.getElementById('pagination');

    if (!resultsContainer) return;
    if (!Array.isArray(currentSearchResults)) currentSearchResults = [];

    const startIndex = (currentPage - 1) * RESULTS_PER_PAGE;
    const endIndex   = Math.min(startIndex + RESULTS_PER_PAGE, currentSearchResults.length);
    const pageResults = currentSearchResults.slice(startIndex, endIndex);

    let html = '';

    pageResults.forEach((result, index) => {
        const globalIndex = startIndex + index;
        const isFeatured  = globalIndex < 3;

        const links   = Array.isArray(result.links) ? result.links : [];
        const sources = Array.isArray(result.sources) ? result.sources : [];

        // Monta handler de clique único (interação + ação)
        const clickCalls = [];
        const safeId = String(result.id || result.title || '')
            .replace(/'/g, "\\'")
            .replace(/"/g, '&quot;');

        // Sempre registrar clique para RL
        clickCalls.push(`handleResultInteraction('${safeId}', 'click')`);

        if (result.isSite && result.siteData) {
            clickCalls.push(`focusOnSearchResult(${globalIndex})`);
        } else if (links[0] && links[0].url && links[0].url !== '#') {
            clickCalls.push(`window.open('${links[0].url}', '_blank')`);
        } else if (links[0] && typeof links[0].action === 'function') {
            clickCalls.push(`handleSearchResultAction(${globalIndex})`);
        }

        const clickAttributes = clickCalls.length
            ? `onclick="${clickCalls.join('; ')}" style="cursor: pointer;"`
            : `style="cursor: default;"`;

        const popularBadge =
            typeof result.relevance === 'number' && result.relevance > 0.8
                ? '<span style="color: #28a745; font-size: 0.7em; margin-left: 8px;">⭐ Popular</span>'
                : '';

        const mainLinkText = result.isSite
            ? 'Sítio Arqueológico'
            : (links[0] && links[0].url ? links[0].url : 'Informação');

        const relevanceText =
            typeof result.relevance === 'number'
                ? `Relevância: ${Math.round(result.relevance * 100)}%`
                : 'Relevância: —';

        html += `
            <div class="result-item ${isFeatured ? 'result-featured' : ''}" data-type="${result.type || ''}" data-index="${globalIndex}">
                <h3 class="result-title" ${clickAttributes}>
                    ${result.title || 'Resultado sem título'}
                    ${popularBadge}
                </h3>
                <div class="result-link">${mainLinkText}</div>
                <div class="result-description">
                    ${result.description || ''}
                </div>
                <div class="result-sources">
                    <div class="sources-title">Fontes confiáveis:</div>
                    <div class="sources-list">
                        ${sources.map(source =>
                            `<a href="${source.url}" class="source-link" target="_blank" rel="noopener noreferrer">${source.name}</a>`
                        ).join('')}
                    </div>
                </div>
                <div class="result-meta">
                    <span class="result-type">${getTypeLabel(result.type)}</span>
                    <span>•</span>
                    <span>${relevanceText}</span>
                    ${result.artifacts > 0 ? `<span>•</span><span>Artefatos: ${result.artifacts}</span>` : ''}
                    ${result.period ? `<span>•</span><span>Período: ${result.period}</span>` : ''}
                </div>
                <div class="search-tags">
                    ${result.isSite
                        ? `<span class="search-tag" onclick="filterByType('${result.type}')">${getTypeLabel(result.type)}</span>`
                        : ''
                    }
                    ${result.period && result.period !== 'Vários períodos'
                        ? `<span class="search-tag" onclick="filterByPeriod('${result.period.replace(/'/g, "\\'")}')">${result.period}</span>`
                        : ''
                    }
                    <span class="search-tag" onclick="handleResultInteraction('${safeId}', 'save')">
                        💾 Salvar
                    </span>
                </div>
            </div>
        `;
    });

    resultsContainer.innerHTML = html;
    if (typeof updatePagination === 'function') {
        updatePagination();
    }
}
     // ===== NOVA FUNÇÃO PARA MANIPULAR INTERAÇÕES (APRIMORADA) ===== //
function handleResultInteraction(itemId, interactionType, data = {}) {
    const input = document.getElementById('searchInput');
    const query = input ? input.value : '';

    if (!window.responseSystem || typeof responseSystem.recordUserInteraction !== 'function') {
        console.warn('responseSystem não está disponível para registrar interações.');
        return;
    }

    responseSystem.recordUserInteraction(query, itemId, interactionType, data);

    if (interactionType === 'save') {
        showNotification('Resultado salvo para melhorar futuras pesquisas!', 'success');
    } else if (interactionType === 'negative') {
        showNotification('Feedback registrado. Vamos tentar melhorar os próximos resultados.', 'warning');
    }
}


// ===== FUNÇÃO PARA MOSTRAR ESTATÍSTICAS DE APRENDIZADO (APRIMORADA) ===== //
function showLearningStats() {
    if (!window.responseSystem || typeof responseSystem.getLearningStats !== 'function') {
        showNotification('Sistema de aprendizado ainda não está disponível.', 'warning', 5000);
        return;
    }

    const stats = responseSystem.getLearningStats();

    const totalQueries       = stats.totalQueries || 0;
    const totalInteractions  = stats.totalInteractions || 0;
    const avgScore           = typeof stats.averageScorePerQuery === 'number'
        ? stats.averageScorePerQuery.toFixed(2)
        : '0.00';
    const mostActiveQuery    = stats.mostActiveQuery || null;
    const lastInteractionRaw = stats.lastInteractionAt || null;
    const lastInteraction    = lastInteractionRaw
        ? new Date(lastInteractionRaw).toLocaleString()
        : 'nenhum registro ainda';

    let message = `Sistema de aprendizado: ${totalQueries} pesquisa(s), ${totalInteractions} interação(ões).`;
    message += ` Média de ${avgScore} pontos por consulta.`;

    if (mostActiveQuery) {
        message += ` Consulta mais ativa: "${mostActiveQuery}".`;
    }

    message += ` Última interação registrada: ${lastInteraction}.`;

    showNotification(message, 'info', 8000);
}


        // ===== FUNÇÕES DO MAPA E SISTEMA PRINCIPAL ===== //

        // Inicialização do mapa principal
        function initializeMap() {
            map = L.map('archaeologicalMap', {
                zoomControl: false,
                attributionControl: false,
                worldCopyJump: false,
                maxBounds: [[-90, -180], [90, 180]],
                maxBoundsViscosity: 1.0,
                minZoom: 2.5
            }).setView([-15.7942, -47.8822], 5);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 19,
  attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

            L.control.zoom({ position: 'topright' }).addTo(map);
            L.control.scale({ position: 'bottomleft', metric: true, imperial: false }).addTo(map);

            // Adicionar sites existentes
            addSitesToMap();
            
            // Adicionar sites do usuário
            addUserSitesToMap();
        }

        // Inicialização do mapa do modal
        function initializeModalMap() {
            if (modalMap) {
                modalMap.remove();
            }

            modalMap = L.map('modalMap', {
                zoomControl: true,
                attributionControl: false,
                worldCopyJump: false
            }).setView([-15.7942, -47.8822], 4);

            L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
                maxZoom: 17,
                attribution: 'Map data: © OpenStreetMap contributors, SRTM | Map style: © OpenTopoMap (CC‑BY‑SA)',
                noWrap: true
            }).addTo(modalMap);

            // Adicionar evento de clique ao mapa do modal
            modalMap.on('click', function(e) {
                if (isSelectingLocation) {
                    onModalMapClick(e);
                }
            });

            return modalMap;
        }

        // ===== FUNÇÕES DE FILTRO OTIMIZADAS ===== //
        function applyFilters() {
            const typeFilter = document.getElementById('filterType').value;
            const periodFilter = document.getElementById('filterPeriod').value;
            
            // Otimização: Remover apenas marcadores visíveis
            currentMarkers.forEach(marker => {
                if (map.hasLayer(marker)) {
                    map.removeLayer(marker);
                }
            });
            
            // Otimização: Reutilizar array em vez de criar novo
            currentMarkers.length = 0;
            
            // Combinar todos os sites uma vez
            const allSites = [...sites, ...userAddedSites];
            
            // Otimização: Filtrar e adicionar em uma única operação
            allSites.forEach(site => {
                const typeMatch = typeFilter === 'all' || site.type === typeFilter;
                const periodMatch = periodFilter === 'all' || (site.period && site.period.includes(periodFilter));
                
                if (typeMatch && periodMatch) {
                    addSiteToMap(site);
                }
            });
            
            showNotification('Filtros aplicados com sucesso!', 'success');
        }
        
        function resetFilters() {
            document.getElementById('filterType').value = 'all';
            document.getElementById('filterPeriod').value = 'all';
            applyFilters();
        }

        // ===== FUNÇÕES DE UPLOAD DE IMAGEM ===== //
        // Alternar entre upload de arquivo e URL
        function setImageSource(type) {
            imageSourceType = type;
            
            // Atualizar UI
            document.querySelectorAll('.upload-option').forEach(option => {
                option.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Mostrar o container correto
            if (type === 'file') {
                document.getElementById('fileUploadContainer').style.display = 'block';
                document.getElementById('urlInputContainer').style.display = 'none';
            } else {
                document.getElementById('fileUploadContainer').style.display = 'none';
                document.getElementById('urlInputContainer').style.display = 'block';
            }
        }

        // Lidar com seleção de arquivo
        function handleFileSelect(event) {
            const file = event.target.files[0];
            const fileNameElement = document.getElementById('fileName');
            const imagePreview = document.getElementById('imagePreview');
            
            if (file) {
                fileNameElement.textContent = file.name;
                
                // Verificar se é uma imagem
                if (!file.type.match('image.*')) {
                    showNotification('Por favor, selecione apenas arquivos de imagem.', 'error');
                    event.target.value = '';
                    fileNameElement.textContent = 'Nenhum arquivo selecionado';
                    imagePreview.style.display = 'none';
                    return;
                }
                
                // Verificar tamanho do arquivo (limite de 5MB)
                if (file.size > 5 * 1024 * 1024) {
                    showNotification('A imagem é muito grande. Por favor, selecione uma imagem menor que 5MB.', 'error');
                    event.target.value = '';
                    fileNameElement.textContent = 'Nenhum arquivo selecionado';
                    imagePreview.style.display = 'none';
                    return;
                }
                
                // Mostrar pré-visualização
                const reader = new FileReader();
                reader.onload = function(e) {
                    imagePreview.src = e.target.result;
                    imagePreview.style.display = 'block';
                };
                reader.readAsDataURL(file);
            } else {
                fileNameElement.textContent = 'Nenhum arquivo selecionado';
                imagePreview.style.display = 'none';
            }
        }

        // Funções do modal
        function openAddModal() {
            // Verificar se o usuário está logado
            if (!isUserLoggedIn()) {
                showNotification('Você precisa estar logado para adicionar um ponto.', 'warning');
                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 2000);
                return;
            }
            
            document.getElementById('addModal').classList.add('active');
            resetForm();
            
            // Resetar para upload de arquivo por padrão
            setImageSource('file');
            
            // Inicializar mapa do modal após um pequeno delay para garantir que o container está visível
            setTimeout(() => {
                initializeModalMap();
            }, 100);
        }

        function closeAddModal() {
            document.getElementById('addModal').classList.remove('active');
            disableMapSelection();
        }

        function enableMapSelection() {
            isSelectingLocation = true;
            document.getElementById('coordinatesInfo').textContent = 'Agora clique em qualquer lugar do mapa para selecionar a localização';
            document.getElementById('coordinatesInfo').style.background = '#e8f5e8';
            document.getElementById('coordinatesInfo').style.color = '#2c5530';
            
            if (modalMap) {
                modalMap.getContainer().style.cursor = 'crosshair';
            }
        }

        function disableMapSelection() {
            isSelectingLocation = false;
            document.getElementById('coordinatesInfo').textContent = 'Clique em "Clicar no Mapa" e depois clique no mapa para selecionar a localização';
            document.getElementById('coordinatesInfo').style.background = '#e9ecef';
            document.getElementById('coordinatesInfo').style.color = '#333';
            
            if (modalMap) {
                modalMap.getContainer().style.cursor = '';
            }
        }

        function onModalMapClick(e) {
            const lat = e.latlng.lat;
            const lng = e.latlng.lng;
            
            // Atualizar campos de coordenadas com alta precisão
            document.getElementById('itemLat').value = lat.toFixed(6);
            document.getElementById('itemLng').value = lng.toFixed(6);
            
            // Atualizar informações
            document.getElementById('coordinatesInfo').textContent = `Localização selecionada: ${lat.toFixed(6)}, ${lng.toFixed(6)}`;
            document.getElementById('coordinatesInfo').style.background = '#d1ecf1';
            document.getElementById('coordinatesInfo').style.color = '#0c5460';
            
            // Adicionar/atualizar marcador no mapa do modal
            if (modalSelectionMarker) {
                modalMap.removeLayer(modalSelectionMarker);
            }
            
            modalSelectionMarker = L.marker([lat, lng], {
                icon: L.divIcon({
                    className: 'selection-marker',
                    html: '<div class="marker-pin selection"></div><i class="fas fa-map-marker-alt"></i>',
                    iconSize: [30, 42],
                    iconAnchor: [15, 42]
                })
            }).addTo(modalMap);
            
            // Centralizar mapa na localização selecionada com zoom mais próximo
            modalMap.setView([lat, lng], Math.max(modalMap.getZoom(), 10));
            
            disableMapSelection();
        }

        function useCurrentLocation() {
            if (!navigator.geolocation) {
                showNotification('Geolocalização não é suportada pelo seu navegador', 'error');
                return;
            }

            document.getElementById('coordinatesInfo').textContent = 'Obtendo sua localização com alta precisão...';
            document.getElementById('coordinatesInfo').style.background = '#fff3cd';
            document.getElementById('coordinatesInfo').style.color = '#856404';

            navigator.geolocation.getCurrentPosition(
                function(position) {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    const accuracy = position.coords.accuracy;
                    
                    // Atualizar campos de coordenadas com alta precisão
                    document.getElementById('itemLat').value = lat.toFixed(6);
                    document.getElementById('itemLng').value = lng.toFixed(6);
                    
                    // Atualizar informações
                    document.getElementById('coordinatesInfo').textContent = `Sua localização: ${lat.toFixed(6)}, ${lng.toFixed(6)} (Precisão: ${Math.round(accuracy)}m)`;
                    document.getElementById('coordinatesInfo').style.background = '#d1ecf1';
                    document.getElementById('coordinatesInfo').style.color = '#0c5460';
                    
                    // Adicionar/atualizar marcador no mapa do modal
                    if (modalSelectionMarker) {
                        modalMap.removeLayer(modalSelectionMarker);
                    }
                    
                    modalSelectionMarker = L.marker([lat, lng], {
                        icon: L.divIcon({
                            className: 'selection-marker',
                            html: '<div class="marker-pin selection"></div><i class="fas fa-map-marker-alt"></i>',
                            iconSize: [30, 42],
                            iconAnchor: [15, 42]
                        })
                    }).addTo(modalMap);
                    
                    // Centralizar mapa na localização com zoom alto
                    modalMap.setView([lat, lng], 15);
                    
                    // Adicionar círculo de precisão se a precisão for conhecida
                    if (accuracy < 1000) {
                        L.circle([lat, lng], {
                            radius: accuracy,
                            color: '#28a745',
                            fillColor: '#28a745',
                            fillOpacity: 0.1,
                            weight: 1
                        }).addTo(modalMap);
                    }
                },
                function(error) {
                    let errorMessage = 'Erro ao obter localização: ';
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMessage += 'Permissão negada pelo usuário';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMessage += 'Localização indisponível';
                            break;
                        case error.TIMEOUT:
                            errorMessage += 'Tempo limite excedido';
                            break;
                        default:
                            errorMessage += 'Erro desconhecido';
                    }
                    document.getElementById('coordinatesInfo').textContent = errorMessage;
                    document.getElementById('coordinatesInfo').style.background = '#f8d7da';
                    document.getElementById('coordinatesInfo').style.color = '#721c24';
                    showNotification(errorMessage, 'error');
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 60000
                }
            );
        }

        function resetForm() {
            const form = document.getElementById('addForm');
            if (form) form.reset();
            
            document.getElementById('coordinatesInfo').textContent = 'Clique em "Clicar no Mapa" e depois clique no mapa para selecionar a localização';
            document.getElementById('coordinatesInfo').style.background = '#e9ecef';
            document.getElementById('coordinatesInfo').style.color = '#333';
            
            if (modalSelectionMarker) {
                modalMap.removeLayer(modalSelectionMarker);
                modalSelectionMarker = null;
            }
            
            // Resetar visualização de arquivo
            document.getElementById('fileName').textContent = 'Nenhum arquivo selecionado';
            document.getElementById('imagePreview').style.display = 'none';
            document.getElementById('imagePreview').src = '';
            
            disableMapSelection();
        }

        // Manipular envio do formulário
        document.getElementById('addForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Verificar se o usuário está logado
            if (!isUserLoggedIn()) {
                showNotification('Você precisa estar logado para adicionar um ponto.', 'warning');
                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 2000);
                return;
            }
            
            const formData = new FormData(this);
            const itemName = formData.get('itemName');
            const itemType = formData.get('itemType');
            const itemPeriod = formData.get('itemPeriod');
            const itemLat = formData.get('itemLat');
            const itemLng = formData.get('itemLng');
            
            // Validação básica
            if (!itemName || !itemType || !itemPeriod || !itemLat || !itemLng) {
                showNotification('Por favor, preencha todos os campos obrigatórios (*)', 'error');
                return;
            }
            
            // Validação de coordenadas
            const lat = parseFloat(itemLat);
            const lng = parseFloat(itemLng);
            if (lat < -90 || lat > 90 || lng < -180 || lng > 180) {
                showNotification('Por favor, insira coordenadas válidas:\nLatitude: -90 a 90\nLongitude: -180 a 180', 'error');
                return;
            }
            
            let imageUrl = 'https://via.placeholder.com/300x200/2c5530/ffffff?text=Imagem+Não+Disponível';
            
            // Se foi selecionado um arquivo, usar data URL
            const fileInput = document.getElementById('itemImageFile');
            if (imageSourceType === 'file' && fileInput.files && fileInput.files[0]) {
                const arquivo = fileInput.files[0];
                
                // Mostrar loading
                const submitBtn = document.getElementById('submitBtn');
                const originalText = submitBtn.innerHTML;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processando imagem...';
                submitBtn.disabled = true;
                
                try {
                    // Usar FileReader para converter para data URL
                    const reader = new FileReader();
                    imageUrl = await new Promise((resolve) => {
                        reader.onload = function(e) {
                            resolve(e.target.result);
                        };
                        reader.readAsDataURL(arquivo);
                    });
                    
                    console.log('✅ Usando imagem do arquivo');
                } catch (error) {
                    console.error('❌ Erro ao processar imagem:', error);
                    showNotification('Erro ao processar imagem. Usando imagem padrão.', 'warning');
                } finally {
                    // Restaurar botão
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;
                }
            } else if (imageSourceType === 'url') {
                // Usar URL se for essa a opção
                imageUrl = document.getElementById('itemImageUrl').value || imageUrl;
                console.log('🔗 Usando URL da imagem:', imageUrl);
            }
            
            // Criar o novo site
            const newSite = {
                id: 'user-' + Date.now(),
                name: itemName,
                type: itemType,
                period: itemPeriod,
                coords: [lat, lng],
                description: document.getElementById('itemDescription').value,
                image: imageUrl,
                siteUrl: document.getElementById('itemSiteUrl').value,
                status: 'Adicionado pelo Usuário',
                artifacts: Math.floor(Math.random() * 200) + 50,
                color: getColorByType(itemType),
                timestamp: new Date().toISOString()
            };

            // Adicionar ao array de sites do usuário
            userAddedSites.push(newSite);
            localStorage.setItem('userAddedSites', JSON.stringify(userAddedSites));

            addSiteToMap(newSite);
            closeAddModal();
            this.reset();
            
            // Resetar visualização
            document.getElementById('fileName').textContent = 'Nenhum arquivo selecionado';
            document.getElementById('imagePreview').style.display = 'none';
            document.getElementById('imagePreview').src = '';
            
            showNotification('Sítio adicionado com sucesso!', 'success');
        });

        // ===== FUNÇÃO getColorByType ATUALIZADA ===== //
        function getColorByType(type) {
            const colorMap = {
                'Sítio em Escavação': '#e74c3c',
                'Sítio Documentado': '#3498db',
                'Área Protegida': '#2ecc71',
                'Artefato Registrado': '#f39c12',
                'Estrutura Arqueológica': '#9b59b6',
                'Museus Arqueológicos': '#f1c40f',
                
                // TIPOS ESPECÍFICOS DO VALE DO PARAÍBA - CORES CORRETAS
                'Sítio de Coleta': '#e74c3c',           // Vermelho - Escavação
                'Sítio Histórico': '#3498db',           // Azul - Documentado  
                'Sítio Cerâmico': '#e74c3c',            // Vermelho - Escavação
                'Sítio Lítico': '#e74c3c',              // Vermelho - Escavação
                'Sítio Lítico-Cerâmico': '#e74c3c',     // Vermelho - Escavação
                'Sítio Lito-Cerâmico': '#e74c3c',       // Vermelho - Escavação
                'Sítio Pré-cerâmico': '#e74c3c',        // Vermelho - Escavação
                'Sítio Raso': '#e74c3c',                // Vermelho - Escavação
                'Sítio Múltiplo': '#e74c3c',            // Vermelho - Escavação
                'Sítio de Ocupação': '#e74c3c',         // Vermelho - Escavação
                'Sítio Funerário': '#3498db',           // Azul - Documentado
                'Sítio de Ocupação Indígena': '#3498db',// Azul - Documentado
                'Aldeia': '#e74c3c',                    // Vermelho - Escavação
                'Acampamento': '#e74c3c',               // Vermelho - Escavação
                'Oficina Lítica': '#f39c12',            // Laranja - Artefato
                'Sambaqui': '#e74c3c',                  // Vermelho - Escavação
                'Cemitério': '#e74c3c',                 // Vermelho - Escavação
                'Abrigo sob Rocha': '#9b59b6',          // Roxo - Estrutura
                'Abrigo com Arte Rupestre': '#9b59b6',  // Roxo - Estrutura
                'Sítio com Arte Rupestre': '#9b59b6'    // Roxo - Estrutura
            };
            return colorMap[type] || '#666666';
        }

        // ===== FUNÇÃO addSiteToMap CORRIGIDA ===== //
        function addSiteToMap(site) {
            if (!map) {
                console.error('Mapa não inicializado');
                return;
            }

            // USAR A COR DO MAPEAMENTO DE TIPOS EM VEZ DA COR FIXA
            const siteColor = getColorByType(site.type);
            
            const marker = L.circleMarker(site.coords, {
                radius: Math.min(8 + (site.artifacts / 100), 20), // Limitar tamanho máximo
                fillColor: siteColor,
                color: '#fff',
                weight: 2,
                opacity: 1,
                fillOpacity: 0.8
            }).addTo(map);

            currentMarkers.push(marker);

            // Otimização: Template string mais eficiente
            const buttonHtml = site.siteUrl ? 
                `<button class="site-link-button" onclick="window.open('${site.siteUrl}', '_blank')">Visitar Site</button>` : '';

            const popupContent = `
                <div class="map-popup">
                    <h2>${site.name}</h2>
                    <img src="${site.image}" alt="${site.name}" loading="lazy" onerror="this.src='https://via.placeholder.com/300x200/2c5530/ffffff?text=Imagem+Não+Disponível'">
                    <div class="popup-meta">
                        <p><strong>Tipo:</strong> ${site.type}</p>
                        <p><strong>Período:</strong> ${site.period}</p>
                        <p><strong>Artefatos:</strong> ${site.artifacts}</p>
                        <p><strong>Status:</strong> ${site.status}</p>
                        ${site.description ? `<p><strong>Descrição:</strong> ${site.description}</p>` : ''}
                        ${buttonHtml}
                    </div>
                </div>
            `;

            marker.bindPopup(popupContent);
            
            // Só abrir popup automaticamente para novos sites do usuário
            if (site.id && site.id.startsWith('user-')) {
                marker.openPopup();
            }

            return site;
        }

        // ===== FUNÇÃO addSitesToMap CORRIGIDA ===== //
        function addSitesToMap() {
            sites.forEach(site => {
                // USAR A COR DO MAPEAMENTO DE TIPOS EM VEZ DA COR FIXA
                const siteColor = getColorByType(site.type);
                
                const marker = L.circleMarker(site.coords, {
                    radius: 8 + (site.artifacts / 100),
                    fillColor: siteColor, // Usar a cor mapeada
                    color: '#fff',
                    weight: 2,
                    opacity: 1,
                    fillOpacity: 0.8
                }).addTo(map);

                // Armazenar referência ao marcador
                currentMarkers.push(marker);

                let buttonHtml = '';
                if (site.siteUrl) {
                    buttonHtml = `<button class="site-link-button" onclick="window.open('${site.siteUrl}', '_blank')">Visitar Site</button>`;
                }

                marker.bindPopup(`
                    <div class="map-popup">
                        <h2>${site.name}</h2>
                        <img src="${site.image}" alt="${site.name}" onerror="this.src='https://via.placeholder.com/300x200/2c5530/ffffff?text=Imagem+Não+Disponível'">
                        <div class="popup-meta">
                            <p><strong>Tipo:</strong> ${site.type}</p>
                            <p><strong>Período:</strong> ${site.period}</p>
                            <p><strong>Artefatos:</strong> ${site.artifacts}</p>
                            <p><strong>Status:</strong> ${site.status}</p>
                            ${site.description ? `<p><strong>Descrição:</strong> ${site.description}</p>` : ''}
                            ${buttonHtml}
                        </div>
                    </div>
                `);
            });
        }

        function addUserSitesToMap() {
            userAddedSites.forEach(site => {
                addSiteToMap(site);
            });
        }

        // Outras funções
        function toggleLegend() {
            const legend = document.getElementById('legendContent');
            const button = document.querySelector('.toggle-button');
            if (legend.style.display === 'none') {
                legend.style.display = 'block';
                button.textContent = '–';
            } else {
                legend.style.display = 'none';
                button.textContent = '+';
            }
        }

        // Verificar se o usuário está logado
        function isUserLoggedIn() {
            const user = localStorage.getItem('archaeologyUser') || sessionStorage.getItem('archaeologyUser');
            return user !== null;
        }

        // Verificar se o usuário está logado e atualizar interface
        function checkUserLogin() {
            const user = localStorage.getItem('archaeologyUser') || sessionStorage.getItem('archaeologyUser');
            const addButtonContainer = document.getElementById('addButtonContainer');
            const loginButtonContainer = document.getElementById('loginButtonContainer');
            
            if (user) {
                // Usuário está logado
                const userData = JSON.parse(user);
                
                // Mostrar botão "Adicionar" e informações do usuário
                addButtonContainer.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span style="color: white; font-size: 14px;">Olá, ${userData.name}</span>
                        <button class="add-btn" onclick="openAddModal()">
                            <i class="fas fa-plus"></i> Adicionar
                        </button>
                    </div>
                `;
                
                // Mostrar botão de logout
                loginButtonContainer.innerHTML = `
                    <button class="logout-btn" onclick="logout()">
                        <i class="fas fa-sign-out-alt"></i> Sair
                    </button>
                `;
            } else {
                // Usuário não está logado
                addButtonContainer.innerHTML = '';
                loginButtonContainer.innerHTML = `
                    <a href="login.html" class="cta-button">Login</a>
                `;
            }
        }

        // Função de logout
        function logout() {
            localStorage.removeItem('archaeologyUser');
            sessionStorage.removeItem('archaeologyUser');
            checkUserLogin(); // Atualizar a interface
            showNotification('Logout realizado com sucesso!', 'success');
        }

        // ===== FUNÇÕES DE PESQUISA EXISTENTES MANTIDAS ===== //

        function showLoading() {
            const resultsContainer = document.getElementById('resultsContainer');
            resultsContainer.innerHTML = `
                <div class="search-loading">
                    <i class="fas fa-spinner"></i>
                    <p>Buscando informações em fontes confiáveis...</p>
                </div>
            `;
            
            document.getElementById('searchResults').classList.add('active');
            document.getElementById('resultsCount').textContent = "Buscando...";
        }

        function updatePagination() {
            const pagination = document.getElementById('pagination');
            const totalPages = Math.ceil(currentSearchResults.length / RESULTS_PER_PAGE);
            
            if (totalPages <= 1) {
                pagination.innerHTML = '';
                return;
            }
            
            let html = '';
            
            // Botão anterior
            html += `<button onclick="changePage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>
                        <i class="fas fa-chevron-left"></i> Anterior
                    </button>`;
            
            // Páginas
            const maxVisiblePages = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
            let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
            
            if (endPage - startPage + 1 < maxVisiblePages) {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }
            
            for (let i = startPage; i <= endPage; i++) {
                html += `<button onclick="changePage(${i})" ${i === currentPage ? 'class="active"' : ''}>${i}</button>`;
            }
            
            // Botão próximo
            html += `<button onclick="changePage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>
                        Próximo <i class="fas fa-chevron-right"></i>
                    </button>`;
            
            pagination.innerHTML = html;
        }

        function changePage(page) {
            const totalPages = Math.ceil(currentSearchResults.length / RESULTS_PER_PAGE);
            
            if (page < 1 || page > totalPages) return;
            
            currentPage = page;
            displayPaginatedResults();
            
            // Rolar para o topo dos resultados
            document.getElementById('searchResults').scrollIntoView({ behavior: 'smooth' });
        }

        function sortResults() {
            const sortBy = document.getElementById('sortResults').value;
            
            currentSearchResults.sort((a, b) => {
                switch (sortBy) {
                    case 'name':
                        return a.title.localeCompare(b.title);
                    case 'name-desc':
                        return b.title.localeCompare(a.title);
                    case 'artifacts':
                        return (b.artifacts || 0) - (a.artifacts || 0);
                    case 'period':
                        return (a.period || '').localeCompare(b.period || '');
                    case 'relevance':
                    default:
                        return b.relevance - a.relevance;
                }
            });
            
            displayPaginatedResults();
        }

        function filterByType(type) {
            document.querySelectorAll('.filter-option').forEach(opt => {
                opt.classList.remove('active');
            });
            
            const typeFilter = document.querySelector(`.filter-option[data-filter="${type}"]`);
            if (typeFilter) {
                typeFilter.classList.add('active');
            }
            
            applyActiveFilter();
        }

        function filterByPeriod(period) {
            document.getElementById('searchPeriod').value = period;
            const query = document.getElementById('searchInput').value;
            if (query) {
                performSearch(query);
            }
        }

        function displayError() {
            const resultsContainer = document.getElementById('resultsContainer');
            resultsContainer.innerHTML = `
                <div class="no-results">
                    <i class="fas fa-exclamation-triangle"></i>
                    <h3>Erro na busca</h3>
                    <p>Não foi possível carregar os resultados. Tente novamente.</p>
                </div>
            `;
            document.getElementById('resultsCount').textContent = "Erro na busca";
        }

        function getTypeLabel(type) {
            const labels = {
                "sites": "Sítio Arqueológico",
                "artifacts": "Artefato",
                "museums": "Museu",
                "structures": "Estrutura",
                "areas": "Área Protegida",
                "general": "Informação Geral",
                "period": "Período Histórico",
                "technique": "Técnica Arqueológica",
                "culture": "Cultura",
                "material": "Material",
                "institution": "Instituição",
                "event": "Evento",
                "help": "Ajuda"
            };
            return labels[type] || "Arqueologia";
        }

        function applyActiveFilter() {
            const activeFilter = document.querySelector('.filter-option.active').dataset.filter;
            const resultItems = document.querySelectorAll('.result-item');
            
            resultItems.forEach(item => {
                if (activeFilter === 'all' || item.dataset.type === activeFilter) {
                    item.style.display = 'block';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        function fillSearch(term) {
            document.getElementById('searchInput').value = term;
            performSearch(term);
            document.getElementById('searchSuggestions').classList.remove('active');
        }

        function toggleAdvancedSearch() {
            const advancedOptions = document.getElementById('advancedOptions');
            const toggleIcon = document.getElementById('advancedToggleIcon');
            
            advancedOptions.classList.toggle('active');
            
            if (advancedOptions.classList.contains('active')) {
                toggleIcon.className = 'fas fa-chevron-up';
            } else {
                toggleIcon.className = 'fas fa-chevron-down';
            }
        }

        // ===== FUNÇÕES DE MANIPULAÇÃO DE CLIQUE NOS RESULTADOS ===== //

        function focusOnSearchResult(index) {
            if (currentSearchResults[index] && currentSearchResults[index].isSite && currentSearchResults[index].siteData) {
                const site = currentSearchResults[index].siteData;
                
                if (map && site.coords) {
                    // Fechar todos os popups primeiro
                    currentMarkers.forEach(marker => {
                        marker.closePopup();
                    });
                    
                    // Centralizar no site
                    map.setView(site.coords, 12);
                    
                    // Encontrar e abrir o popup do marcador correspondente
                    setTimeout(() => {
                        currentMarkers.forEach(marker => {
                            const markerLatLng = marker.getLatLng();
                            if (Math.abs(markerLatLng.lat - site.coords[0]) < 0.001 && 
                                Math.abs(markerLatLng.lng - site.coords[1]) < 0.001) {
                                marker.openPopup();
                            }
                        });
                    }, 500);
                    
                    // Rolar para a seção do mapa
                    document.getElementById('map').scrollIntoView({ behavior: 'smooth' });
                }
            }
        }

        function handleSearchResultAction(index) {
            const result = currentSearchResults[index];
            
            if (result.links && result.links[0]) {
                const link = result.links[0];
                
                if (link.action) {
                    // Executar ação específica se definida
                    if (typeof link.action === 'function') {
                        link.action();
                    } else if (typeof link.action === 'string' && link.action.includes('fillSearch')) {
                        // Executar ação de preenchimento de busca
                        eval(link.action);
                    }
                } else if (link.url && link.url !== '#') {
                    // Abrir URL em nova aba
                    window.open(link.url, '_blank');
                }
            }
        }

        // ===== HISTÓRICO DE PESQUISAS ===== //

        function saveToSearchHistory(query, resultsCount) {
            // Remove duplicatas mais antigas
            const filteredHistory = searchHistory.filter(item => item.query !== query);
            
            // Adiciona nova entrada
            filteredHistory.unshift({
                query,
                timestamp: new Date().toISOString(),
                resultsCount: resultsCount
            });
            
            // Mantém apenas as 10 mais recentes
            const limitedHistory = filteredHistory.slice(0, 10);
            localStorage.setItem('archaeologySearchHistory', JSON.stringify(limitedHistory));
        }

        function showSearchHistoryInSuggestions() {
            if (searchHistory.length === 0) return '';
            
            let html = '<div class="suggestion-category">Histórico de buscas</div>';
            searchHistory.forEach(item => {
                html += `
                    <div class="history-item" onclick="fillSearch('${item.query}')">
                        <span class="history-query">${item.query}</span>
                        <span class="history-meta">${item.resultsCount} resultados</span>
                    </div>
                `;
            });
            return html;
        }

        // ===== SUGESTÕES DE BUSCA APRIMORADAS ===== //

        function showSearchSuggestions(query) {
            const suggestionsContainer = document.getElementById('searchSuggestions');
            
            if (!query || query.length < 1) {
                // Mostrar histórico quando não há consulta
                const historyHTML = showSearchHistoryInSuggestions();
                if (historyHTML) {
                    suggestionsContainer.innerHTML = historyHTML;
                    suggestionsContainer.classList.add('active');
                } else {
                    suggestionsContainer.classList.remove('active');
                }
                return;
            }
            
            if (query.length < 2) {
                suggestionsContainer.classList.remove('active');
                return;
            }
            
            const suggestions = generateEnhancedSuggestions(query);
            
            if (suggestions.length === 0) {
                suggestionsContainer.classList.remove('active');
                return;
            }
            
            let html = '<div class="suggestion-category">Sugestões</div>';
            suggestions.forEach(suggestion => {
                html += `<div class="suggestion-item" onclick="fillSearch('${suggestion}')">
                            <div class="suggestion-icon"><i class="fas fa-search"></i></div>
                            <div>${suggestion}</div>
                         </div>`;
            });
            
            suggestionsContainer.innerHTML = html;
            suggestionsContainer.classList.add('active');
        }

        // ===== INICIALIZAÇÃO ATUALIZADA ===== //
        document.addEventListener('DOMContentLoaded', function() {
            // Inicializar mapa
            initializeMap();
            checkUserLogin();
            
            // Event listeners para busca
            document.getElementById('searchButton').addEventListener('click', function() {
                const query = document.getElementById('searchInput').value;
                performSearch(query);
            });
            
            document.getElementById('searchInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    const query = this.value;
                    performSearch(query);
                }
            });
            
            // Event listener para sugestões de busca
            document.getElementById('searchInput').addEventListener('input', function(e) {
                showSearchSuggestions(this.value);
            });
            
            // Fechar sugestões ao clicar fora
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.search-box')) {
                    document.getElementById('searchSuggestions').classList.remove('active');
                }
            });
            
            // Event listeners para filtros
            document.querySelectorAll('.filter-option').forEach(option => {
                option.addEventListener('click', function() {
                    document.querySelectorAll('.filter-option').forEach(opt => {
                        opt.classList.remove('active');
                    });
                    this.classList.add('active');
                    applyActiveFilter();
                });
            });
            
            // Mostrar estatísticas de aprendizado (para demonstração)
            setTimeout(showLearningStats, 3000);
            
            // Smooth scroll
            document.querySelectorAll('a[href^="#"]').forEach(anchor => {
                anchor.addEventListener('click', function(e) {
                    e.preventDefault();
                    const targetId = this.getAttribute('href');
                    if (targetId === '#') return;
                    const targetElement = document.querySelector(targetId);
                    if (targetElement) {
                        const targetPosition = targetElement.getBoundingClientRect().top + window.pageYOffset - 80;
                        window.scrollTo({
                            top: targetPosition,
                            behavior: 'smooth'
                        });
                    }
                });
            });

            // Fechar modal ao clicar fora
            const addModal = document.getElementById('addModal');
            if (addModal) {
                addModal.addEventListener('click', function(e) {
                    if (e.target === this) {
                        closeAddModal();
                    }
                });
            }

            // Otimização: Delegação de eventos para inputs de coordenadas
            const form = document.getElementById('addForm');
            if (form) {
                form.addEventListener('change', function(e) {
                    if (e.target.id === 'itemLat' || e.target.id === 'itemLng') {
                        updateMarkerFromCoordinates();
                    }
                });
            }
        });

        function updateMarkerFromCoordinates() {
            const lat = parseFloat(document.getElementById('itemLat').value);
            const lng = parseFloat(document.getElementById('itemLng').value);
            
            if (!isNaN(lat) && !isNaN(lng) && modalMap) {
                // Atualizar informações
                document.getElementById('coordinatesInfo').textContent = `Localização: ${lat.toFixed(6)}, ${lng.toFixed(6)}`;
                document.getElementById('coordinatesInfo').style.background = '#d1ecf1';
                document.getElementById('coordinatesInfo').style.color = '#0c5460';
                
                // Adicionar/atualizar marcador no mapa do modal
                if (modalSelectionMarker) {
                    modalMap.removeLayer(modalSelectionMarker);
                }
                
                modalSelectionMarker = L.marker([lat, lng], {
                    icon: L.divIcon({
                        className: 'selection-marker',
                        html: '<div class="marker-pin selection"></div><i class="fas fa-map-marker-alt"></i>',
                        iconSize: [30, 42],
                        iconAnchor: [15, 42]
                    })
                }).addTo(modalMap);
                
                // Centralizar mapa na localização
                modalMap.setView([lat, lng], Math.max(modalMap.getZoom(), 10));
            }
        }

        // Função global para ir para site
        function irParaSite() {
            window.location.href = "https://mab.unasp.edu.br/";
        }

        // Dados COMPLETOS dos sites originais - TODOS RESTAURADOS
        const sites = [
            {
                id: 'site-01',
                name: 'Lapa do Santo',
                coords: [-19.605, -44.000],
                type: 'Sítio em Escavação',
                period: 'Holoceno Inicial',
                status: 'Documentado',
                artifacts: 800,
                color: '#e74c3c',
                image: 'fotos/isblog05.jpg'
            },
            {
                id: 'site-02',
                name: 'Caverna da Pedra Pintada',
                coords: [-1.99768, -54.07239], 
                type: 'Sítio Documentado',
                period: 'Pleistoceno–Holoceno',
                status: 'Documentado',
                artifacts: 42,
                image: 'fotos/6b242fff068c7c41102b319c37e38ab374e70375.jpg',
                color: '#3498db'
            },
            {
                id: 'site-03',
                name: 'Sambaqui do Moa',
                coords: [-22.9667, -42.0333], 
                type: 'Área Protegida',
                period: 'Holoceno Médio',
                status: 'Protegido',
                artifacts: 356,
                image: 'fotos/image032.jpg',
                color: '#2ecc71'
            },
            {
                id: 'site-04',
                name: 'Terra Preta do Índio',
                coords: [-3.1667, -60.0167], 
                type: 'Sítio Documentado',
                period: 'Holoceno Tardio',
                status: 'Documentado',
                artifacts: 215,
                image: 'fotos/24RA542.jpg',
                color: '#3498db'
            },
            {
                id: 'site-05',
                name: 'Serra da Capivara',
                coords: [-8.8371, -42.5636],
                type: 'Área Protegida',
                period: 'Pleistoceno–Holoceno',
                status: 'Patrimônio Mundial',
                artifacts: 1200,
                image: 'fotos/serradacapivara-vidasemparedes-33-1024x576.webp',
                color: '#2ecc71'
            },
            {
                id: 'site-06',
                name: 'Museu de Arqueologia Bíblica - (MAB/UNASP)',
                coords: [-22.5011, -47.1651],
                type: 'Museus Arqueológicos',
                period: 'Contemporâneo',
                status: 'Ativo',
                artifacts: 150,
                color: '#f1c40f',
                siteUrl: 'https://tour.unasp.edu.br/mab',
                image: 'fotos/images (1).jpg'
            },
            {
                id: 'site-07',
                name: 'Universidade de São Paulo – Museu de Arqueologia e Etnologia (MAE/USP)',
                coords: [-23.561399, -46.730789], 
                type: 'Museus Arqueológicos',
                period: 'Pré-colonial a Contemporâneo',
                status: 'Ativo',
                artifacts: 150,
                color: '#f1c40f',
                image: 'fotos/12DC341.jpg',
                siteUrl: 'USP.html'
            },
            {
                id: 'site-08',
                name: 'Museu de Arqueologia e Etnologia (MAE/UFBA)',
                coords: [-12.972771, -38.510216], 
                type: 'Museus Arqueológicos',
                period: 'Pré-colonial, colonial e contemporâneo',
                status: 'Ativo',
                artifacts: 200,
                image: 'fotos/images (2).jpg', 
                color: '#f1c40f'
            },
            {
                id: 'artefato-02',
                name: 'Capacete celta de bronze',
                coords: [52.400, 21.150],
                type: 'Artefato Registrado',
                period: 'Idade do Ferro',
                status: 'Achado isolado em área rural',
                artifacts: 200,
                site: 'Desconhecido (fora de sítio celta)',
                image: 'fotos/Celtic_-_Helmet_Italo-Celtic_3rd_century_BC_(bronze)_-_(MeisterDrucke-241460).jpg',
                color: '#f39c12'
            },
            {
                id: 'artefato-03',
                name: 'Fragmento cerâmico Tupi',
                coords: [-16.0056, -51.3971],
                type: 'Artefato Registrado',
                period: 'Pré-colonial',
                status: 'Disperso em área agrícola',
                site: 'Montes Claros de Goiás',
                artifacts: 200,
                image: 'fotos/fragmentos.jpg',
                color: '#f39c12'
            },
            {
                id: 'artefato-04',
                name: 'Lesma lítica (Tradição Itaparica)',
                coords: [-10.000, -56.000],
                type: 'Artefato Registrado',
                period: 'Pré-cerâmica',
                status: 'Encontrado fora de abrigo',
                site: 'Tradição Itaparica',
                artifacts: 200,
                image: 'fotos/images (3).jpg',
                color: '#f39c12'
            },
            {
                id: 'artefato-05',
                name: 'Machado polido isolado',
                coords: [-19.630, -43.882],
                type: 'Artefato Registrado',
                period: 'Holoceno Médio',
                status: 'Fora de contexto',
                site: 'Região de Lagoa Santa',
                artifacts: 200,
                image: 'fotos/463-1.jpg',
                color: '#f39c12'
            },
            {
                id: 'artefato-06',
                name: 'Estatueta romana em mármore',
                coords: [41.9028, 12.4964],
                type: 'Artefato Registrado',
                period: 'Império Romano',
                status: 'Recuperado em mercado ilegal',
                site: 'Origem incerta',
                artifacts: 200,
                image: 'fotos/ah-padrao-2024-10-18t125446055.jpg',
                color: '#f39c12'
            },
            {
                id: 'artefato-07',
                name: 'Cerâmica Marajoara',
                coords: [-9.9085, -64.3050],
                type: 'Artefato Registrado',
                period: 'Pré-colombiano',
                status: 'Encontrada fora de sítio',
                site: 'Região do Rio Madeira',
                artifacts: 200,
                image: 'fotos/Cylindrical_vessel_Collection_H_Law_170_n2.jpg',
                color: '#f39c12'
            },
            {
                id: 'artefato-08',
                name: 'Pontas de flecha tupinambá',
                coords: [-23.5505, -46.6333],
                type: 'Artefato Registrado',
                period: 'Pré-colonial',
                status: 'Disperso em área florestal',
                site: 'Mata Atlântica',
                artifacts: 200,
                image: 'fotos/Fleche_Cartailhac_MHNT_PRE_2009.0.232.2_simple (1).jpg',
                color: '#f39c12'
            },
            {
                id: 'artefato-09',
                name: 'Fóssil de Luzia',
                coords: [-19.9317, -43.9408],
                type: 'Artefato Registrado',
                period: 'Pleistoceno final (cerca de 11.500 anos)',
                status: 'Parcialmente preservado após incêndio',
                site: 'Lapa Vermelha, Pedro Leopoldo - MG',
                artifacts: 200,
                image: 'fotos/cranio_de_luzia.jpg',
                color: '#f39c12'
            },
            {
                id: 'area-01',
                name: 'Parque Nacional da Tijuca',
                coords: [-22.9485, -43.2343],
                type: 'Área Protegida',
                status: 'Protegida',
                biome: 'Mata Atlântica',
                artifacts: 850,
                image: 'fotos/images (4).jpg',
                color: '#2ecc71'
            },
            {
                id: 'area-02',
                name: 'Reserva Biológica de Sooretama',
                coords: [-19.0892, -40.3150],
                type: 'Área Protegida',
                status: 'Protegida',
                biome: 'Mata Atlântica',
                artifacts: 400,
                image: 'fotos/ipatrimonio-Sooretama-Reserva-Biologica-de-Sooretama-Imagem-ICMBio.jpg',
                color: '#2ecc71'
            },
            {
                id: 'area-03',
                name: 'Parque Nacional do Pico da Neblina',
                coords: [0.8173, -66.5600],
                type: 'Área Protegida',
                status: 'Protegida',
                biome: 'Amazônia',
                artifacts: 1200,
                image: 'fotos/Pico_da_Neblina.jpg',
                color: '#2ecc71'
            },
            {
                id: 'area-05',
                name: 'Reserva Extrativista Marinha do Marajó',
                coords: [-0.9847, -49.6663],
                type: 'Área Protegida',
                status: 'Protegida',
                biome: 'Amazônia',
                artifacts: 600,
                image: 'fotos/images (5).jpg',
                color: '#2ecc71'
            },
            {
                id: 'area-06',
                name: 'Floresta Nacional do Tapajós',
                coords: [-3.4766, -57.1181],
                type: 'Área Protegida',
                status: 'Protegida',
                biome: 'Amazônia',
                artifacts: 1100,
                image: 'fotos/images (6).jpg',
                color: '#2ecc71'
            },
            {
                id: 'area-07',
                name: 'Parque Indígena do Xingu',
                coords: [-12.5000, -52.5000],
                type: 'Área Protegida',
                status: 'Protegida',
                biome: 'Cerrado / Amazônia',
                artifacts: 1300,
                image: 'fotos/1.jpeg',
                color: '#2ecc71'
            },
            {
                id: 'area-08',
                name: 'Parque Nacional da Chapada Diamantina',
                coords: [-12.5000, -41.4500],
                type: 'Área Protegida',
                status: 'Protegida',
                biome: 'Caatinga / Mata Atlântica',
                artifacts: 700,
                image: 'fotos/Desde_o_Morro_do_Pai_Inácio.jpg',
                color: '#2ecc71'
            },
            {
                id: 'estrut-01',
                name: 'Templo do Sol (Coricancha)',
                coords: [-13.5181, -71.9786],
                type: 'Estrutura Arqueológica',
                status: 'Ruínas preservadas',
                description: 'Templo solar principal do Império Inca, base de construções posteriores.',
                artifacts: 450,
                image: 'fotos/images (7).jpg',
                color: '#9b59b6'
            },
            {
                id: 'estrut-02',
                name: 'Pirâmide do Sol',
                coords: [19.6925, -98.8438],
                type: 'Estrutura Arqueológica',
                status: 'Conservada',
                description: 'Uma das maiores pirâmides da América pré-colombiana, centro cerimonial.',
                artifacts: 1200,
                image: 'fotos/images (9).jpg',
                color: '#9b59b6'
            },
            {
                id: 'estrut-03',
                name: 'Templo de Ártemis',
                coords: [37.9582, 27.3642],
                type: 'Estrutura Arqueológica',
                status: 'Ruínas fragmentadas',
                description: 'Construído em homenagem à deusa Ártemis, foi uma das Sete Maravilhas do Mundo Antigo, destruído por um incêndio e saqueado.',
                artifacts: 120,
                image: 'fotos/images (16).jpg',
                color: '#9b59b6'
            },
            {
                id: 'estrut-04',
                name: 'Palácio de Knossos',
                coords: [35.2989, 25.1648],
                type: 'Estrutura Arqueológica',
                status: 'Ruínas',
                description: 'Complexo palaciano da civilização minoana, com frescos e arquitetura sofisticada.',
                artifacts: 600,
                image: 'fotos/images (8).jpg',
                color: '#9b59b6'
            },
            {
                id: 'estrut-05',
                name: 'Muralhas de Chan Chan',
                coords: [-8.1120, -79.0330],
                type: 'Estrutura Arqueológica',
                status: 'Ruínas',
                description: 'Ruínas de antiga capital Chimú, com grandes muralhas e palácios.',
                artifacts: 900,
                image: 'fotos/istockphoto-498796572-612x612.jpg',
                color: '#9b59b6'
            },
            {
                id: 'estrut-06',
                name: 'Templo de Kukulkán (El Castillo)',
                coords: [20.6829, -88.5698],
                type: 'Estrutura Arqueológica',
                status: 'Preservada',
                description: 'Pirâmide escalonada dedicada ao deus Kukulkán, famosa por seu alinhamento astronômico.',
                artifacts: 1000,
                image: 'fotos/images (10).jpg',
                color: '#9b59b6'
            },
            {
                id: 'estrut-07',
                name: 'Templo de Hathor',
                coords: [25.7403, 32.6014],
                type: 'Estrutura Arqueológica',
                status: 'Ruínas',
                description: 'Templo dedicado à deusa Hathor, com relevos e arquitetura bem preservada.',
                artifacts: 700,
                image: 'fotos/images (11).jpg',
                color: '#9b59b6'
            },
            {
                id: 'estrut-08',
                name: 'Ruínas da Igreja de São Miguel das Missões',
                coords: [-27.4941, -54.5810],
                type: 'Estrutura Arqueológica',
                status: 'Parcialmente preservada',
                description: 'Igreja da missão jesuítica do século XVIII, importante para a história colonial.',
                artifacts: 350,
                image: 'fotos/images (12).jpg',
                color: '#9b59b6'
            },
            {
                id: 'estrut-09',
                name: 'Pirâmide de Cochasquí',
                coords: [-0.0055, -78.4098],
                type: 'Estrutura Arqueológica',
                status: 'Ruínas',
                description: 'Complexo arqueológico com pirâmides truncadas e plataformas cerimoniais.',
                artifacts: 500,
                image: 'fotos/Foto-142-Piramide-de-Cochasqui.jpg',
                color: '#9b59b6'
            },
            {
                id: 'estrut-10',
                name: 'Fortaleza de Sacsayhuamán',
                coords: [-13.5090, -71.9817],
                type: 'Estrutura Arqueológica',
                status: 'Ruínas',
                description: 'Estrutura megalítica com pedras encaixadas com precisão incrível.',
                artifacts: 800,
                image: 'fotos/images (13).jpg',
                color: '#9b59b6'
            },
            {
                id: 'estrut-11',
                name: 'Templo de Kalasasaya',
                coords: [-16.5613, -68.6537],
                type: 'Estrutura Arqueológica',
                status: 'Ruínas',
                description: 'Grande templo cerimonial com estruturas de pedra monumental.',
                artifacts: 650,
                image: 'fotos/Templo_de_Kalasasaya_a_socha_Monolito_Ponce_-_Tiwanaku_-_panoramio_(1) (1).jpg',
                color: '#9b59b6'
            },
            {
                id: 'estrut-12',
                name: 'Mausoléu de Halicarnasso',
                coords: [37.0379, 27.4241],
                type: 'Estrutura Arqueológica',
                status: 'Ruínas parciais',
                description: 'Uma das Sete Maravilhas do Mundo Antigo, tumba construída para Mausolo, sátrapa da Cária.',
                artifacts: 150,
                image: 'fotos/download (2).jpg',
                color: '#9b59b6'
            },
            {
                id: 'escav-01',
                name: 'Sambaqui do Bacanga',
                coords: [-2.5333, -44.2833],
                type: 'Sítio em Escavação',
                status: 'Em escavação',
                description: 'Sítio costeiro com conchas, esqueletos humanos e artefatos líticos.',
                artifacts: 720,
                image: 'fotos/Figura-6-Escavacao-da-Superficie-Ampla-no-Sambaqui-do-Bacanga.png',
                color: '#e74c3c'
            },
            {
                id: 'escav-02',
                name: 'Sítio Arqueológico do Alto da Estiva',
                coords: [-7.2306, -35.8811],
                type: 'Sítio em Escavação',
                status: 'Escavação em andamento',
                description: 'Fragmentos cerâmicos, estruturas de ocupação e sepultamentos.',
                artifacts: 430,
                image: 'fotos/stioarqueolgicotocadaanta.webp',
                color: '#e74c3c'
            },
            {
                id: 'escav-03',
                name: 'Sítio Furna do Estrago',
                coords: [-8.2831, -36.0153],
                type: 'Sítio em Escavação',
                status: 'Escavação ativa',
                description: 'Importante para o estudo da transição entre caçadores-coletores e ceramistas.',
                artifacts: 860,
                image: 'fotos/images (14).jpg',
                color: '#e74c3c'
            },
            {
                id: 'escav-04',
                name: 'Sítio do Riacho do Meio',
                coords: [-9.3958, -37.9972],
                type: 'Sítio em Escavação',
                status: 'Investigação em curso',
                description: 'Ocorrência de material lítico e ossadas humanas em bom estado.',
                artifacts: 390,
                image: 'fotos/riachodomeio.jpg',
                color: '#e74c3c'
            },
            {
                id: 'escav-05',
                name: 'Sítio Arqueológico Santa Elina',
                coords: [-15.1333, -59.0833],
                type: 'Sítio em Escavação',
                status: 'Escavações recentes',
                description: 'Possível presença de megafauna associada a humanos.',
                artifacts: 510,
                image: 'fotos/Parede_do_Sítio_arqueológico_Santa_Elina.jpg',
                color: '#e74c3c'
            },
            {
                id: 'escav-06',
                name: 'Sítio da Lapa do Boquete',
                coords: [-14.3206, -43.8456],
                type: 'Sítio em Escavação',
                status: 'Escavação ativa',
                description: 'Sepultamentos com urnas funerárias e ferramentas.',
                artifacts: 740,
                image: 'fotos/janelao.jpg',
                color: '#e74c3c'
            },
            {
                id: 'escav-07',
                name: 'Sítio Arqueológico do Vale do Ribeira',
                coords: [-24.6000, -48.7000],
                type: 'Sítio em Escavação',
                status: 'Pesquisas em andamento',
                description: 'Material ósseo, cerâmico e estruturas rituais pré-coloniais.',
                artifacts: 620,
                image: 'fotos/images (15).jpg',
                color: '#e74c3c'
            },
            {
                id: 'escav-08',
                name: 'Sítio Pedra do Alexandre',
                coords: [-6.8847, -39.8781],
                type: 'Sítio em Escavação',
                status: 'Escavação recente',
                description: 'Arte rupestre e artefatos associados a rituais.',
                artifacts: 360,
                image: 'fotos/Figura-5-Enterramento-15-do-sitio-Pedra-do-Alexandre-Area-Arqueologica-do-Serido (1).png',
                color: '#e74c3c'
            },
            // SÍTIOS NOVOS ADICIONADOS //
            {
                id: 'site-sjc-mariana-01',
                name: 'Sítio Arqueológico Jardim Mariana I - São José dos Campos',
                coords: [-23.2342, -45.8994],
                type: 'Sítio de Ocupação Indígena',
                period: 'Período Pré-Colonial (~400 anos)',
                culture: 'Tupi-Guarani',
                status: 'Em Estudo pelo IPHAN',
                artifacts: 300,
                description: 'Descoberta acidental em 2021 durante obras. Materiais indicam assentamento indígena com práticas de subsistência e armazenamento.',
                institution: 'IPHAN / Fundação Cultural Cassiano Ricardo',
                access: 'Não aberto à visitação pública',
                color: '#3498db',
                image: 'fotos/250478117_4262692817162826_2384230040786853257_n'
            },
            {
                id: 'sp-sj-03',
                name: 'São José SJ.03',
                coords: [-23.5225, -46.1883], // Mogi das Cruzes
                type: 'Sítio Histórico',
                period: 'Colonial',
                status: 'Documentado',
                artifacts: 85,
                site: 'Mogi das Cruzes - SP',
                description: 'Sítio histórico com presença de cerâmica neobrasileira',
                color: '#3498db',
                image: 'fotos/IMG_20200819_113159819_HDR (1).jpg'
            },
            {
                id: 'sp-piraju-01',
                name: 'Arruda',
                coords: [-23.1944, -49.3839], // Piraju
                type: 'Oficina Lítica',
                period: 'Pré-colonial',
                status: 'Documentado',
                artifacts: 65,
                site: 'Piraju - SP',
                description: 'Oficina lítica para produção de ferramentas',
                color: '#f39c12',
                image: 'fotos/f8e203_3d0bd5cb11fc4e97bb03726778d8dc48.avif'
            },
            {
                id: 'sp-narandiba-01', 
                name: 'Narandiba 2',
                coords: [-22.4056, -51.5269], // Narandiba
                type: 'Aldeia',
                period: 'Pré-colonial',
                status: 'Documentado',
                artifacts: 120,
                site: 'Narandiba - SP',
                description: 'Aldeia de horticultores ceramistas',
                color: '#e74c3c',
                image: 'fotos/lH3VENDoSwB1jNYgWLwuCSDtyyyxicSTkJbZAKgU.jpeg'
            },
            {
                id: 'sp-peruibe-01',
                name: 'Ilha do Rio Guaraú - Sambaqui',
                coords: [-24.3167, -47.0000], // Peruíbe
                type: 'Sambaqui',
                period: 'Pré-colonial',
                status: 'Documentado',
                artifacts: 200,
                site: 'Peruíbe - SP',
                description: 'Sambaqui conchífero na Estação Ecológica Juréia-Itatins',
                color: '#e74c3c',
                image: 'fotos/2010-335794526-2010061327138.jpg_20100613.jpg'
            },
            {
                id: 'sp-ilhabela-01',
                name: 'Engenho da Feiticeira',
                coords: [-23.7889, -45.3583], // Ilhabela
                type: 'Sítio Histórico',
                period: 'Colonial',
                status: 'Documentado',
                artifacts: 90,
                site: 'Ilhabela - SP',
                description: 'Ruínas de um engenho d\'água construído no período colonial',
                color: '#3498db',
                image: 'fotos/ilhabela-historia-sitio-arqueologico-bx-1024x761.jpg.webp'
            },
            {
                id: 'sp-ilhabela-02',
                name: 'Acampamento Búzios',
                coords: [-23.7889, -45.3583], // Ilhabela
                type: 'Acampamento',
                period: 'Pré-colonial',
                status: 'Documentado',
                artifacts: 75,
                site: 'Ilhabela - SP',
                description: 'Acampamento pré-histórico do litoral',
                color: '#e74c3c',
                image: 'fotos/gruta-da-ilha-dos-buzios-capa.jpg'
            },
            {
                id: 'sp-ilhabela-03',
                name: 'Aldeia Viana',
                coords: [-23.7889, -45.3667], // Ilhabela
                type: 'Aldeia',
                period: 'Pré-colonial',
                status: 'Documentado',
                artifacts: 110,
                site: 'Ilhabela - SP',
                description: 'Antiga aldeia indígena na Praia da Viana',
                color: '#e74c3c',
                image: 'fotos/Arqueologia_6-min.jpg'
            },
            {
                id: 'sp-iguape-01',
                name: 'Rio das Pedras II (26-Ig-12)',
                coords: [-24.7083, -47.5500], // Iguape
                type: 'Estrutura Arqueológica',
                period: 'Pré-colonial',
                status: 'Documentado',
                artifacts: 45,
                site: 'Iguape - SP',
                description: 'Paredes e pilares feitos com alvenaria de pedra',
                color: '#9b59b6',
                image: 'fotos/75a4cec3-b504-4aed-9130-4c1fc6c073d0.jpeg'
            },
            {
                id: 'sp-iguape-02',
                name: 'Caverna do Ódio Nº 14',
                coords: [-24.7083, -47.5500], // Iguape
                type: 'Sambaqui',
                period: 'Pré-colonial',
                status: 'Documentado',
                artifacts: 130,
                site: 'Iguape - SP',
                description: 'Sítio conchífero sob abrigo rochoso no sopé do Morro do Espia',
                color: '#e74c3c',
                image: 'fotos/100.jpg'
            },
            {
                id: 'sp-olimpia-01',
                name: 'Cemitério Maranata',
                coords: [-20.7372, -48.9147], // Olímpia
                type: 'Sítio Funerário',
                period: 'Pré-colonial',
                status: 'Documentado',
                artifacts: 95,
                site: 'Olímpia - SP',
                description: 'Sítio cemitério com quatro urnas funerárias e vasilhames',
                color: '#e74c3c',
                image: 'fotos/Visita-Maranata-2.jpg'
            },
            {
                id: 'sp-analandia-01',
                name: 'Abrigo da Santa',
                coords: [-22.1289, -47.6619], // Analândia
                type: 'Abrigo com Arte Rupestre',
                period: 'Pré-colonial',
                status: 'Documentado',
                artifacts: 60,
                site: 'Analândia - SP',
                description: 'Sinalizações rupestres em abrigo sob rocha na Fazenda Chapotepec',
                color: '#9b59b6',
                image: 'fotos/images (17).jpg'
            },
            {
                id: 'sp-ubatuba-01',
                name: 'Itaguá',
                coords: [-23.4333, -45.0833], // Ubatuba
                type: 'Sítio Lito-Cerâmico',
                period: 'Pré-colonial',
                status: 'Documentado',
                artifacts: 150,
                site: 'Ubatuba - SP',
                description: 'Sítio lito-cerâmico da tradição Tupiguarani no Morro do Itaguá',
                color: '#e74c3c',
                image: 'fotos/images (18).jpg'
            },
            {
                id: 'sp-teodoro-01',
                name: 'Canuto II',
                coords: [-22.5306, -52.1675], // Teodoro Sampaio
                type: 'Sítio Lito-Cerâmico',
                period: 'Pré-colonial',
                status: 'Documentado',
                artifacts: 100,
                site: 'Teodoro Sampaio - SP',
                description: 'Sítio lito-cerâmico a céu aberto no distrito de Rosana',
                color: '#e74c3c',
                image: 'fotos/Figura-2-1-scaled-e1686865499701.webp'
            },
            {
                id: 'sp-tatui-01',
                name: 'Alpargatas',
                coords: [-23.3556, -47.8569], // Tatuí
                type: 'Sítio Cerâmico',
                period: 'Pré-colonial',
                status: 'Documentado',
                artifacts: 110,
                site: 'Tatuí - SP',
                description: 'Sítio cerâmico com ocorrência de urna funerária na Fábrica Alpargatas',
                color: '#e74c3c',
                image: 'fotos/Arqueologia-696x522.jpg'
            },
            {
                id: 'sp-iporanga-01',
                name: 'Abrigo Maximiano',
                coords: [-24.5847, -48.5922], // Iporanga
                type: 'Abrigo sob Rocha',
                period: 'Pré-colonial',
                status: 'Documentado',
                artifacts: 75,
                site: 'Iporanga - SP',
                description: 'Abrigo sob rocha com ocorrência de sepultamentos',
                color: '#9b59b6',
                image: 'fotos/pinturarupestreiphan.avif'
            },
            {
                id: 'sp-ipeuna-01',
                name: 'Abrigo da Glória',
                coords: [-22.4369, -47.7186], // Ipeúna
                type: 'Abrigo sob Rocha',
                period: 'Pré-colonial',
                status: 'Documentado',
                artifacts: 55,
                site: 'Ipeúna - SP',
                description: 'Abrigo com ocorrência de lítico lascado na Fazenda São José da Glória',
                color: '#9b59b6',
                image: 'fotos/img-20231214-wa0081-1-.avif'
            },
            {
                id: 'sp-ipero-01',
                name: 'Abrigo das Abelhas',
                coords: [-23.3500, -47.7167], // Iperó
                type: 'Abrigo sob Rocha',
                period: 'Pré-colonial',
                status: 'Documentado',
                artifacts: 50,
                site: 'Iperó - SP',
                description: 'Abrigo sob rocha com ocorrência de material lítico na Fazenda Ipanema',
                color: '#9b59b6',
                image: 'fotos/_Abelhas_.jpg'
            },
            {
                id: 'sp-cajuru-01',
                name: 'Abrigo das Furnas SP-MR-17',
                coords: [-21.2833, -47.3000], // Cajuru
                type: 'Abrigo com Arte Rupestre',
                period: 'Pré-colonial',
                status: 'Documentado',
                artifacts: 40,
                site: 'Cajuru - SP',
                description: 'Abrigo com pinturas rupestres',
                color: '#9b59b6',
                image: 'fotos/sitio-arqueologico-montes-claros.jpg'
            }
        ];
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker
        .register('/service-worker.js')
        .then(reg => {
          console.log('Service Worker registrado com escopo:', reg.scope);
        })
        .catch(err => {
          console.error('Falha ao registrar Service Worker:', err);
        });
    });
  }
        window.sites = sites;
        // ===== SISTEMA DE ACESSIBILIDADE BÁSICO =====
(function () {
  const STORAGE_KEY = 'archaeologyworld-accessibility';

  const defaultState = {
    fontSize: 'normal', // small | normal | large | xlarge
    highContrast: false
  };

  function loadState() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return { ...defaultState };
      const parsed = JSON.parse(raw);
      return { ...defaultState, ...parsed };
    } catch (e) {
      return { ...defaultState };
    }
  }

  function saveState(state) {
    try {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    } catch (e) {
      // se der erro no storage (modo privado etc.), só ignora
    }
  }

  function applyState(state) {
    const body = document.body;

    // limpa classes antigas
    body.classList.remove(
      'font-size-small',
      'font-size-normal',
      'font-size-large',
      'font-size-xlarge',
      'high-contrast'
    );

    // aplica tamanho de fonte
    const sizeClass = {
      small: 'font-size-small',
      normal: 'font-size-normal',
      large: 'font-size-large',
      xlarge: 'font-size-xlarge'
    }[state.fontSize] || 'font-size-normal';

    body.classList.add(sizeClass);

    // aplica contraste
    if (state.highContrast) {
      body.classList.add('high-contrast');
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    const state = loadState();
    applyState(state);

    const btnSkip = document.getElementById('acc-skip');
    const btnIncrease = document.getElementById('acc-font-increase');
    const btnDecrease = document.getElementById('acc-font-decrease');
    const btnContrast = document.getElementById('acc-contrast-toggle');
    const mainContent = document.getElementById('conteudo-principal');

    // Skip link: vai direto pro conteúdo principal
    if (btnSkip && mainContent) {
      btnSkip.addEventListener('click', () => {
        mainContent.focus();
      });
    }

    // Aumentar fonte
    if (btnIncrease) {
      btnIncrease.addEventListener('click', () => {
        const order = ['small', 'normal', 'large', 'xlarge'];
        const currentIndex = order.indexOf(state.fontSize);
        const nextIndex = Math.min(order.length - 1, currentIndex + 1);
        state.fontSize = order[nextIndex];
        applyState(state);
        saveState(state);
      });
    }

    // Diminuir fonte
    if (btnDecrease) {
      btnDecrease.addEventListener('click', () => {
        const order = ['small', 'normal', 'large', 'xlarge'];
        const currentIndex = order.indexOf(state.fontSize);
        const nextIndex = Math.max(0, currentIndex - 1);
        state.fontSize = order[nextIndex];
        applyState(state);
        saveState(state);
      });
    }

    // Alternar alto contraste
    if (btnContrast) {
      btnContrast.setAttribute('aria-pressed', String(state.highContrast));

      btnContrast.addEventListener('click', () => {
        state.highContrast = !state.highContrast;
        btnContrast.setAttribute('aria-pressed', String(state.highContrast));
        applyState(state);
        saveState(state);
      });
    }
  });
})();

    </script>
</body>
</html>